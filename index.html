<!doctype html>

<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta
            name="apple-mobile-web-app-status-bar-style"
            content="black-translucent"
        />
        <title>Parley Chat</title>
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.production.min.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            * {
                -webkit-tap-highlight-color: transparent;
            }

            html {
                background: #000;
                overscroll-behavior: none;
                -webkit-overflow-scrolling: touch;
            }

            body {
                margin: 0;
                padding: 0;
                background: #000;
                overscroll-behavior: none;
                position: fixed;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            #root {
                background: #000;
                height: 100%;
                overscroll-behavior: none;
            }

            .scroll-container {
                overscroll-behavior: contain;
                -webkit-overflow-scrolling: touch;
            }

            .glass {
                background: rgba(17, 24, 39, 0.7);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
            }

            .glass-light {
                background: rgba(31, 41, 55, 0.5);
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
            }

            .glass-oled {
                background: rgba(0, 0, 0, 0.95);
            }

            .glass-light-oled {
                background: rgba(10, 10, 10, 0.8);
            }

            input[type="range"] {
                -webkit-appearance: none;
                appearance: none;
                background: transparent;
                cursor: pointer;
            }

            input[type="range"]::-webkit-slider-track {
                background: rgba(75, 85, 99, 0.5);
                height: 0.5rem;
                border-radius: 0.5rem;
            }

            input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                height: 1.25rem;
                width: 1.25rem;
                border-radius: 50%;
                background: rgb(96, 165, 250);
                cursor: pointer;
                margin-top: -0.375rem;
            }

            input[type="range"]::-moz-range-track {
                background: rgba(75, 85, 99, 0.5);
                height: 0.5rem;
                border-radius: 0.5rem;
            }

            input[type="range"]::-moz-range-thumb {
                height: 1.25rem;
                width: 1.25rem;
                border-radius: 50%;
                background: rgb(96, 165, 250);
                cursor: pointer;
                border: none;
            }

            .image-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1rem;
            }

            @media (max-width: 640px) {
                .image-grid {
                    grid-template-columns: repeat(
                        auto-fill,
                        minmax(150px, 1fr)
                    );
                }
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useRef, useEffect } = React;

            const DEFAULT_TEMPLATES = [
                {
                    name: "CUSTOM",
                    systemPrompt: "You are a helpful assistant.",
                    model: "anthropic/claude-3.5-sonnet",
                },
                {
                    name: "DUNGEON MASTER",
                    systemPrompt:
                        "You are an expert dungeon master running a fantasy RPG campaign. Describe scenes vividly, respond to player actions dynamically, and maintain consistent world rules. Keep track of inventory, stats, and consequences.",
                    model: "anthropic/claude-3.5-sonnet",
                },
                {
                    name: "SCI-FI COMPANION",
                    systemPrompt:
                        "You are an AI companion aboard a deep space vessel in the year 2247. You are helpful, slightly sarcastic, and concerned about the crew's wellbeing. You have access to ship systems and historical databases.",
                    model: "anthropic/claude-3.5-sonnet",
                },
                {
                    name: "DETECTIVE NOIR",
                    systemPrompt:
                        "You are a hard-boiled private detective in 1940s Los Angeles. Speak in noir style with vivid descriptions. The user is your client or partner. Maintain mystery and atmosphere.",
                    model: "anthropic/claude-3.5-sonnet",
                },
                {
                    name: "WISE MENTOR",
                    systemPrompt:
                        "You are an ancient sage who speaks in thoughtful, philosophical tones. You guide the seeker (user) through their journey with wisdom, riddles, and meaningful questions. You have seen empires rise and fall.",
                    model: "anthropic/claude-3.5-sonnet",
                },
                {
                    name: "VILLAIN",
                    systemPrompt:
                        "You are a charismatic villain who believes they are the hero of their own story. Monologue dramatically, reveal your plans theatrically, and engage in witty banter with the hero (user).",
                    model: "anthropic/claude-3.5-sonnet",
                },
            ];

            // LocalStorage helper functions
            const loadFromStorage = (key, defaultValue) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (error) {
                    console.error(
                        `Error loading ${key} from localStorage:`,
                        error,
                    );
                    return defaultValue;
                }
            };

            const saveToStorage = (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (error) {
                    console.error(
                        `Error saving ${key} to localStorage:`,
                        error,
                    );
                }
            };

            function ParleyChat() {
                const [branches, setBranches] = useState(() =>
                    loadFromStorage("parley_branches", { main: [] }),
                );
                const [currentBranch, setCurrentBranch] = useState(() =>
                    loadFromStorage("parley_currentBranch", "main"),
                );
                const [input, setInput] = useState("");
                const [apiKey, setApiKey] = useState(() =>
                    loadFromStorage("parley_apiKey", ""),
                );
                const [model, setModel] = useState(() =>
                    loadFromStorage(
                        "parley_model",
                        "anthropic/claude-3.5-sonnet",
                    ),
                );
                const [systemPrompt, setSystemPrompt] = useState(() =>
                    loadFromStorage(
                        "parley_systemPrompt",
                        "You are a helpful assistant.",
                    ),
                );
                const [loading, setLoading] = useState(false);
                const [showSettings, setShowSettings] = useState(true);
                const [selectedTemplate, setSelectedTemplate] = useState(() =>
                    loadFromStorage("parley_selectedTemplate", "CUSTOM"),
                );
                const [customTemplates, setCustomTemplates] = useState(() =>
                    loadFromStorage("parley_customTemplates", []),
                );
                const [newTemplateName, setNewTemplateName] = useState("");
                const [editingIndex, setEditingIndex] = useState(null);
                const [editText, setEditText] = useState("");

                const [temperature, setTemperature] = useState(() =>
                    loadFromStorage("parley_temperature", 1.0),
                );
                const [maxTokens, setMaxTokens] = useState(() =>
                    loadFromStorage("parley_maxTokens", 2000),
                );
                const [topP, setTopP] = useState(() =>
                    loadFromStorage("parley_topP", 1.0),
                );
                const [frequencyPenalty, setFrequencyPenalty] = useState(() =>
                    loadFromStorage("parley_frequencyPenalty", 0),
                );
                const [presencePenalty, setPresencePenalty] = useState(() =>
                    loadFromStorage("parley_presencePenalty", 0),
                );
                const [showAdvanced, setShowAdvanced] = useState(false);
                const [streamingText, setStreamingText] = useState("");
                const [isStreaming, setIsStreaming] = useState(false);

                const [characterCard, setCharacterCard] = useState(() =>
                    loadFromStorage("parley_characterCard", null),
                );
                const [showCharacterCard, setShowCharacterCard] =
                    useState(false);

                const [searchQuery, setSearchQuery] = useState("");
                const [showSearch, setShowSearch] = useState(false);
                const [searchResults, setSearchResults] = useState([]);
                const [currentSearchIndex, setCurrentSearchIndex] = useState(0);
                const [oledMode, setOledMode] = useState(() =>
                    loadFromStorage("parley_oledMode", false),
                );

                // Image generation state
                const [mode, setMode] = useState(() =>
                    loadFromStorage("parley_mode", "chat"),
                );
                const [imagePrompt, setImagePrompt] = useState("");
                const [negativePrompt, setNegativePrompt] = useState("");
                const [imageModel, setImageModel] = useState(() =>
                    loadFromStorage("parley_imageModel", "fal-ai/flux/schnell"),
                );
                const [imageSize, setImageSize] = useState(() =>
                    loadFromStorage("parley_imageSize", "square_hd"),
                );
                const [numInferenceSteps, setNumInferenceSteps] = useState(() =>
                    loadFromStorage("parley_numInferenceSteps", 4),
                );
                const [guidanceScale, setGuidanceScale] = useState(() =>
                    loadFromStorage("parley_guidanceScale", 3.5),
                );
                const [numImages, setNumImages] = useState(() =>
                    loadFromStorage("parley_numImages", 1),
                );
                const [generatedImages, setGeneratedImages] = useState(() =>
                    loadFromStorage("parley_generatedImages", []),
                );
                const [imageLoading, setImageLoading] = useState(false);
                const [falApiKey, setFalApiKey] = useState(() =>
                    loadFromStorage("parley_falApiKey", ""),
                );
                const [replicateApiKey, setReplicateApiKey] = useState(() =>
                    loadFromStorage("parley_replicateApiKey", ""),
                );
                const [imageProvider, setImageProvider] = useState(() =>
                    loadFromStorage("parley_imageProvider", "fal"),
                );
                const [savedModels, setSavedModels] = useState(() =>
                    loadFromStorage("parley_savedModels", []),
                );
                const [newModelName, setNewModelName] = useState("");

                const messagesEndRef = useRef(null);
                const abortControllerRef = useRef(null);
                const searchResultRefs = useRef([]);

                const messages = branches[currentBranch] || [];

                // Persistence effects
                useEffect(() => {
                    saveToStorage("parley_branches", branches);
                }, [branches]);

                useEffect(() => {
                    saveToStorage("parley_currentBranch", currentBranch);
                }, [currentBranch]);

                useEffect(() => {
                    saveToStorage("parley_apiKey", apiKey);
                }, [apiKey]);

                useEffect(() => {
                    saveToStorage("parley_model", model);
                }, [model]);

                useEffect(() => {
                    saveToStorage("parley_systemPrompt", systemPrompt);
                }, [systemPrompt]);

                useEffect(() => {
                    saveToStorage("parley_selectedTemplate", selectedTemplate);
                }, [selectedTemplate]);

                useEffect(() => {
                    saveToStorage("parley_customTemplates", customTemplates);
                }, [customTemplates]);

                useEffect(() => {
                    saveToStorage("parley_temperature", temperature);
                }, [temperature]);

                useEffect(() => {
                    saveToStorage("parley_maxTokens", maxTokens);
                }, [maxTokens]);

                useEffect(() => {
                    saveToStorage("parley_topP", topP);
                }, [topP]);

                useEffect(() => {
                    saveToStorage("parley_frequencyPenalty", frequencyPenalty);
                }, [frequencyPenalty]);

                useEffect(() => {
                    saveToStorage("parley_presencePenalty", presencePenalty);
                }, [presencePenalty]);

                useEffect(() => {
                    saveToStorage("parley_characterCard", characterCard);
                }, [characterCard]);

                useEffect(() => {
                    saveToStorage("parley_oledMode", oledMode);
                }, [oledMode]);

                useEffect(() => {
                    saveToStorage("parley_mode", mode);
                }, [mode]);

                useEffect(() => {
                    saveToStorage("parley_imageModel", imageModel);
                }, [imageModel]);

                useEffect(() => {
                    saveToStorage("parley_imageSize", imageSize);
                }, [imageSize]);

                useEffect(() => {
                    saveToStorage(
                        "parley_numInferenceSteps",
                        numInferenceSteps,
                    );
                }, [numInferenceSteps]);

                useEffect(() => {
                    saveToStorage("parley_guidanceScale", guidanceScale);
                }, [guidanceScale]);

                useEffect(() => {
                    saveToStorage("parley_numImages", numImages);
                }, [numImages]);

                useEffect(() => {
                    saveToStorage("parley_generatedImages", generatedImages);
                }, [generatedImages]);

                useEffect(() => {
                    saveToStorage("parley_falApiKey", falApiKey);
                }, [falApiKey]);

                useEffect(() => {
                    saveToStorage("parley_replicateApiKey", replicateApiKey);
                }, [replicateApiKey]);

                useEffect(() => {
                    saveToStorage("parley_imageProvider", imageProvider);
                }, [imageProvider]);

                useEffect(() => {
                    saveToStorage("parley_savedModels", savedModels);
                }, [savedModels]);

                const scrollToBottom = () => {
                    messagesEndRef.current?.scrollIntoView({
                        behavior: "smooth",
                    });
                };

                useEffect(() => {
                    scrollToBottom();
                }, [messages, streamingText]);

                useEffect(() => {
                    if (searchQuery.trim()) {
                        const results = [];
                        messages.forEach((msg, idx) => {
                            if (
                                msg.content
                                    .toLowerCase()
                                    .includes(searchQuery.toLowerCase())
                            ) {
                                results.push(idx);
                            }
                        });
                        setSearchResults(results);
                        setCurrentSearchIndex(0);
                    } else {
                        setSearchResults([]);
                        setCurrentSearchIndex(0);
                    }
                }, [searchQuery, messages]);

                useEffect(() => {
                    if (
                        searchResults.length > 0 &&
                        searchResultRefs.current[
                            searchResults[currentSearchIndex]
                        ]
                    ) {
                        searchResultRefs.current[
                            searchResults[currentSearchIndex]
                        ]?.scrollIntoView({
                            behavior: "smooth",
                            block: "center",
                        });
                    }
                }, [currentSearchIndex, searchResults]);

                const allTemplates = [...DEFAULT_TEMPLATES, ...customTemplates];

                const loadTemplate = (templateName) => {
                    const template = allTemplates.find(
                        (t) => t.name === templateName,
                    );
                    if (template) {
                        setSystemPrompt(template.systemPrompt);
                        setModel(template.model);
                        setSelectedTemplate(templateName);
                    }
                };

                const saveCustomTemplate = () => {
                    if (!newTemplateName.trim()) return;

                    const newTemplate = {
                        name: newTemplateName.toUpperCase(),
                        systemPrompt: systemPrompt,
                        model: model,
                    };

                    setCustomTemplates((prev) => [...prev, newTemplate]);
                    setSelectedTemplate(newTemplate.name);
                    setNewTemplateName("");
                };

                const deleteCustomTemplate = (templateName) => {
                    setCustomTemplates((prev) =>
                        prev.filter((t) => t.name !== templateName),
                    );
                    if (selectedTemplate === templateName) {
                        setSelectedTemplate("CUSTOM");
                    }
                };

                const saveCurrentModel = () => {
                    if (!newModelName.trim()) return;

                    const newModel = {
                        name: newModelName,
                        endpoint: model,
                    };

                    setSavedModels((prev) => [...prev, newModel]);
                    setNewModelName("");
                };

                const loadSavedModel = (endpoint) => {
                    setModel(endpoint);
                };

                const deleteSavedModel = (modelName) => {
                    setSavedModels((prev) =>
                        prev.filter((m) => m.name !== modelName),
                    );
                };

                const updateMessages = (newMessages) => {
                    setBranches((prev) => ({
                        ...prev,
                        [currentBranch]: newMessages,
                    }));
                };

                const generateResponse = async (messageHistory) => {
                    setLoading(true);
                    setIsStreaming(true);
                    setStreamingText("");

                    abortControllerRef.current = new AbortController();

                    try {
                        const response = await fetch(
                            "https://openrouter.ai/api/v1/chat/completions",
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${apiKey}`,
                                },
                                body: JSON.stringify({
                                    model: model,
                                    messages: [
                                        {
                                            role: "system",
                                            content: systemPrompt,
                                        },
                                        ...messageHistory,
                                    ],
                                    temperature: temperature,
                                    max_tokens: maxTokens,
                                    top_p: topP,
                                    frequency_penalty: frequencyPenalty,
                                    presence_penalty: presencePenalty,
                                    stream: true,
                                }),
                                signal: abortControllerRef.current.signal,
                            },
                        );

                        if (!response.ok) {
                            throw new Error(
                                `HTTP error! status: ${response.status}`,
                            );
                        }

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let fullText = "";

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value, {
                                stream: true,
                            });
                            const lines = chunk.split("\n");

                            for (const line of lines) {
                                if (line.startsWith("data: ")) {
                                    const data = line.slice(6);

                                    if (data === "[DONE]") {
                                        continue;
                                    }

                                    try {
                                        const parsed = JSON.parse(data);
                                        const content =
                                            parsed.choices?.[0]?.delta?.content;

                                        if (content) {
                                            fullText += content;
                                            setStreamingText(fullText);
                                        }
                                    } catch (e) {
                                        // Skip malformed JSON
                                    }
                                }
                            }
                        }

                        setIsStreaming(false);
                        setStreamingText("");
                        abortControllerRef.current = null;
                        return fullText;
                    } catch (error) {
                        setIsStreaming(false);

                        if (error.name === "AbortError") {
                            const partialText = streamingText;
                            setStreamingText("");
                            abortControllerRef.current = null;
                            return (
                                partialText || "[Generation stopped by user]"
                            );
                        }

                        setStreamingText("");
                        abortControllerRef.current = null;
                        throw error;
                    } finally {
                        setLoading(false);
                    }
                };

                const stopGeneration = () => {
                    if (abortControllerRef.current) {
                        abortControllerRef.current.abort();
                    }
                };

                const sendMessage = async () => {
                    if (!input.trim() || !apiKey) return;

                    const userMessage = { role: "user", content: input };
                    const newMessages = [...messages, userMessage];
                    updateMessages(newMessages);
                    setInput("");

                    try {
                        const content = await generateResponse(newMessages);
                        const assistantMessage = { role: "assistant", content };
                        updateMessages([...newMessages, assistantMessage]);
                    } catch (error) {
                        updateMessages([
                            ...newMessages,
                            {
                                role: "system",
                                content: `Error: ${error.message}`,
                            },
                        ]);
                    }
                };

                const regenerateMessage = async (index) => {
                    if (index < 1) return;

                    const messagesUpToPoint = messages.slice(0, index);
                    updateMessages(messagesUpToPoint);

                    try {
                        const content =
                            await generateResponse(messagesUpToPoint);
                        const assistantMessage = { role: "assistant", content };
                        updateMessages([
                            ...messagesUpToPoint,
                            assistantMessage,
                        ]);
                    } catch (error) {
                        updateMessages([
                            ...messagesUpToPoint,
                            {
                                role: "system",
                                content: `Error: ${error.message}`,
                            },
                        ]);
                    }
                };

                const deleteMessage = (index) => {
                    const newMessages = messages.filter((_, i) => i !== index);
                    updateMessages(newMessages);
                };

                const forkBranch = (index) => {
                    const branchName = `branch_${Date.now()}`;
                    const newMessages = messages.slice(0, index + 1);
                    setBranches((prev) => ({
                        ...prev,
                        [branchName]: newMessages,
                    }));
                    setCurrentBranch(branchName);
                };

                const startEdit = (index) => {
                    setEditingIndex(index);
                    setEditText(messages[index].content);
                };

                const saveEdit = async (index) => {
                    const editedMessage = {
                        role: messages[index].role,
                        content: editText,
                    };
                    const messagesUpToEdit = [
                        ...messages.slice(0, index),
                        editedMessage,
                    ];
                    updateMessages(messagesUpToEdit);
                    setEditingIndex(null);
                    setEditText("");

                    if (
                        messages[index].role === "user" &&
                        index < messages.length - 1
                    ) {
                        try {
                            const content =
                                await generateResponse(messagesUpToEdit);
                            const assistantMessage = {
                                role: "assistant",
                                content,
                            };
                            updateMessages([
                                ...messagesUpToEdit,
                                assistantMessage,
                            ]);
                        } catch (error) {
                            updateMessages([
                                ...messagesUpToEdit,
                                {
                                    role: "system",
                                    content: `Error: ${error.message}`,
                                },
                            ]);
                        }
                    }
                };

                const cancelEdit = () => {
                    setEditingIndex(null);
                    setEditText("");
                };

                const deleteBranch = (branchName) => {
                    if (branchName === "main") return;

                    const newBranches = { ...branches };
                    delete newBranches[branchName];
                    setBranches(newBranches);

                    if (currentBranch === branchName) {
                        setCurrentBranch("main");
                    }
                };

                const clearAllData = () => {
                    if (
                        confirm(
                            "Are you sure you want to clear all data? This will reset everything including conversations, settings, and templates.",
                        )
                    ) {
                        // Clear all localStorage
                        Object.keys(localStorage).forEach((key) => {
                            if (key.startsWith("parley_")) {
                                localStorage.removeItem(key);
                            }
                        });
                        // Reload the page to reset state
                        window.location.reload();
                    }
                };

                const exportConversation = (format = "json") => {
                    if (format === "json") {
                        const exportData = {
                            branches,
                            currentBranch,
                            systemPrompt,
                            model,
                            temperature,
                            maxTokens,
                            topP,
                            frequencyPenalty,
                            presencePenalty,
                            exportDate: new Date().toISOString(),
                        };

                        const blob = new Blob(
                            [JSON.stringify(exportData, null, 2)],
                            { type: "application/json" },
                        );
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = `parley_${Date.now()}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                    } else if (format === "markdown") {
                        let markdown = `# Parley Conversation\n\n`;
                        markdown += `**Model:** ${model}\n`;
                        markdown += `**System Prompt:** ${systemPrompt}\n`;
                        markdown += `**Date:** ${new Date().toISOString()}\n\n`;
                        markdown += `---\n\n`;

                        messages.forEach((msg, idx) => {
                            const role =
                                msg.role === "user"
                                    ? "**User**"
                                    : msg.role === "assistant"
                                      ? "**Assistant**"
                                      : "**System**";
                            markdown += `### ${role} [#${idx}]\n\n${msg.content}\n\n`;
                        });

                        const blob = new Blob([markdown], {
                            type: "text/markdown",
                        });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = `parley_${Date.now()}.md`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                };

                const importConversation = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);

                            if (data.branches) {
                                setBranches(data.branches);
                                setCurrentBranch(data.currentBranch || "main");
                            }

                            if (data.systemPrompt)
                                setSystemPrompt(data.systemPrompt);
                            if (data.model) setModel(data.model);
                            if (data.temperature !== undefined)
                                setTemperature(data.temperature);
                            if (data.maxTokens !== undefined)
                                setMaxTokens(data.maxTokens);
                            if (data.topP !== undefined) setTopP(data.topP);
                            if (data.frequencyPenalty !== undefined)
                                setFrequencyPenalty(data.frequencyPenalty);
                            if (data.presencePenalty !== undefined)
                                setPresencePenalty(data.presencePenalty);

                            setSelectedTemplate("CUSTOM");
                        } catch (error) {
                            alert(
                                "Failed to import conversation: " +
                                    error.message,
                            );
                        }
                    };
                    reader.readAsText(file);

                    event.target.value = "";
                };

                const extractPNGMetadata = async (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const arr = new Uint8Array(e.target.result);
                            let offset = 8;

                            while (offset < arr.length) {
                                const length =
                                    (arr[offset] << 24) |
                                    (arr[offset + 1] << 16) |
                                    (arr[offset + 2] << 8) |
                                    arr[offset + 3];
                                const type = String.fromCharCode(
                                    ...arr.slice(offset + 4, offset + 8),
                                );

                                if (type === "tEXt") {
                                    const data = arr.slice(
                                        offset + 8,
                                        offset + 8 + length,
                                    );
                                    const text = new TextDecoder().decode(data);
                                    const nullIndex = text.indexOf("\0");
                                    const key = text.slice(0, nullIndex);
                                    const value = text.slice(nullIndex + 1);

                                    if (key === "chara") {
                                        try {
                                            const decoded = atob(value);
                                            const card = JSON.parse(decoded);
                                            resolve(card);
                                            return;
                                        } catch (e) {
                                            reject(
                                                new Error(
                                                    "Invalid character card data",
                                                ),
                                            );
                                            return;
                                        }
                                    }
                                }

                                offset += 12 + length;
                            }
                            reject(new Error("No character card found in PNG"));
                        };
                        reader.onerror = () =>
                            reject(new Error("Failed to read file"));
                        reader.readAsArrayBuffer(file);
                    });
                };

                const importCharacterCard = async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    try {
                        let card;

                        if (file.name.endsWith(".png")) {
                            card = await extractPNGMetadata(file);
                        } else if (file.name.endsWith(".json")) {
                            const text = await file.text();
                            card = JSON.parse(text);
                        } else {
                            alert("Please select a PNG or JSON file");
                            return;
                        }

                        setCharacterCard(card);
                        setShowCharacterCard(true);
                    } catch (error) {
                        alert(
                            "Failed to import character card: " + error.message,
                        );
                    }

                    event.target.value = "";
                };

                const applyCharacterCard = () => {
                    if (!characterCard) return;

                    const data = characterCard.data || characterCard;

                    let prompt = "";

                    if (data.name) {
                        prompt += `Character: ${data.name}\n\n`;
                    }

                    if (data.description) {
                        prompt += `Description: ${data.description}\n\n`;
                    }

                    if (data.personality) {
                        prompt += `Personality: ${data.personality}\n\n`;
                    }

                    if (data.scenario) {
                        prompt += `Scenario: ${data.scenario}\n\n`;
                    }

                    if (data.mes_example) {
                        prompt += `Example Dialogue:\n${data.mes_example}\n\n`;
                    }

                    prompt += `You are ${data.name || "this character"}. Stay in character and respond naturally.`;

                    setSystemPrompt(prompt);
                    setSelectedTemplate("CUSTOM");

                    if (data.first_mes) {
                        const firstMessage = {
                            role: "assistant",
                            content: data.first_mes,
                        };
                        updateMessages([firstMessage]);
                    }

                    setShowCharacterCard(false);
                };

                const exportCharacterCard = () => {
                    if (!characterCard) return;

                    const blob = new Blob(
                        [JSON.stringify(characterCard, null, 2)],
                        { type: "application/json" },
                    );
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    const name = (
                        characterCard.data?.name ||
                        characterCard.name ||
                        "character"
                    ).replace(/\s+/g, "_");
                    a.download = `${name}_card.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                };

                const createCharacterCard = () => {
                    const card = {
                        spec: "chara_card_v2",
                        spec_version: "2.0",
                        data: {
                            name: "",
                            description: "",
                            personality: "",
                            scenario: "",
                            first_mes: "",
                            mes_example: "",
                            creator_notes: "",
                            system_prompt: systemPrompt,
                            post_history_instructions: "",
                            tags: [],
                            creator: "",
                            character_version: "1.0",
                            extensions: {},
                        },
                    };

                    setCharacterCard(card);
                    setShowCharacterCard(true);
                };

                const updateCharacterCardField = (field, value) => {
                    setCharacterCard((prev) => ({
                        ...prev,
                        data: {
                            ...prev.data,
                            [field]: value,
                        },
                    }));
                };

                const nextSearchResult = () => {
                    if (searchResults.length > 0) {
                        setCurrentSearchIndex(
                            (prev) => (prev + 1) % searchResults.length,
                        );
                    }
                };

                const prevSearchResult = () => {
                    if (searchResults.length > 0) {
                        setCurrentSearchIndex(
                            (prev) =>
                                (prev - 1 + searchResults.length) %
                                searchResults.length,
                        );
                    }
                };

                const highlightText = (text, query) => {
                    if (!query.trim()) return text;

                    const parts = text.split(new RegExp(`(${query})`, "gi"));
                    return parts
                        .map((part, i) =>
                            part.toLowerCase() === query.toLowerCase()
                                ? `<<HIGHLIGHT>>${part}<<ENDHIGHLIGHT>>`
                                : part,
                        )
                        .join("");
                };

                const handleKeyPress = (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                };

                // Image generation functions
                const generateImage = async () => {
                    if (!imagePrompt.trim()) {
                        alert("Please provide a prompt");
                        return;
                    }

                    if (imageProvider === "fal" && !falApiKey) {
                        alert("Please provide a FAL API key");
                        return;
                    }

                    if (imageProvider === "replicate" && !replicateApiKey) {
                        alert("Please provide a Replicate API key");
                        return;
                    }

                    setImageLoading(true);

                    try {
                        if (imageProvider === "fal") {
                            // FAL.ai generation
                            const sizeMap = {
                                square_hd: { width: 1024, height: 1024 },
                                square: { width: 512, height: 512 },
                                portrait_4_3: { width: 768, height: 1024 },
                                portrait_16_9: { width: 576, height: 1024 },
                                landscape_4_3: { width: 1024, height: 768 },
                                landscape_16_9: { width: 1024, height: 576 },
                            };

                            const size = sizeMap[imageSize] || sizeMap.square_hd;

                            const payload = {
                                prompt: imagePrompt,
                                image_size: imageSize,
                                num_inference_steps: numInferenceSteps,
                                num_images: numImages,
                            };

                            if (negativePrompt.trim()) {
                                payload.negative_prompt = negativePrompt;
                            }

                            if (imageModel !== "fal-ai/flux/schnell") {
                                payload.guidance_scale = guidanceScale;
                            }

                            const response = await fetch(
                                `https://fal.run/${imageModel}`,
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        Authorization: `Key ${falApiKey}`,
                                    },
                                    body: JSON.stringify(payload),
                                },
                            );

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(
                                    errorData.detail ||
                                        `HTTP error! status: ${response.status}`,
                                );
                            }

                            const data = await response.json();
                            const images = data.images || [];
                            const newImages = images.map((img) => ({
                                url: img.url,
                                prompt: imagePrompt,
                                model: imageModel,
                                provider: "fal",
                                timestamp: Date.now(),
                                settings: {
                                    size: imageSize,
                                    steps: numInferenceSteps,
                                    guidance: guidanceScale,
                                    negativePrompt: negativePrompt,
                                },
                            }));

                            setGeneratedImages((prev) => [...newImages, ...prev]);
                        } else {
                            // Replicate generation
                            const sizeMap = {
                                square_hd: { width: 1024, height: 1024 },
                                square: { width: 512, height: 512 },
                                portrait_4_3: { width: 768, height: 1024 },
                                portrait_16_9: { width: 576, height: 1024 },
                                landscape_4_3: { width: 1024, height: 768 },
                                landscape_16_9: { width: 1024, height: 576 },
                            };

                            const size = sizeMap[imageSize] || sizeMap.square_hd;

                            const payload = {
                                version: imageModel,
                                input: {
                                    prompt: imagePrompt,
                                    width: size.width,
                                    height: size.height,
                                    num_inference_steps: numInferenceSteps,
                                    num_outputs: numImages,
                                },
                            };

                            if (negativePrompt.trim()) {
                                payload.input.negative_prompt = negativePrompt;
                            }

                            if (imageModel !== "fal-ai/flux/schnell") {
                                payload.input.guidance_scale = guidanceScale;
                            }

                            const response = await fetch(
                                "https://api.replicate.com/v1/predictions",
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        Authorization: `Token ${replicateApiKey}`,
                                    },
                                    body: JSON.stringify(payload),
                                },
                            );

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(
                                    errorData.detail ||
                                        `HTTP error! status: ${response.status}`,
                                );
                            }

                            const prediction = await response.json();

                            // Poll for completion
                            let result = prediction;
                            while (
                                result.status !== "succeeded" &&
                                result.status !== "failed"
                            ) {
                                await new Promise((resolve) =>
                                    setTimeout(resolve, 1000),
                                );
                                const pollResponse = await fetch(
                                    `https://api.replicate.com/v1/predictions/${result.id}`,
                                    {
                                        headers: {
                                            Authorization: `Token ${replicateApiKey}`,
                                        },
                                    },
                                );
                                result = await pollResponse.json();
                            }

                            if (result.status === "failed") {
                                throw new Error(
                                    result.error || "Image generation failed",
                                );
                            }

                            const imageUrls = Array.isArray(result.output)
                                ? result.output
                                : [result.output];
                            const newImages = imageUrls.map((url) => ({
                                url: url,
                                prompt: imagePrompt,
                                model: imageModel,
                                provider: "replicate",
                                timestamp: Date.now(),
                                settings: {
                                    size: imageSize,
                                    steps: numInferenceSteps,
                                    guidance: guidanceScale,
                                    negativePrompt: negativePrompt,
                                },
                            }));

                            setGeneratedImages((prev) => [...newImages, ...prev]);
                        }
                    } catch (error) {
                        alert("Failed to generate image: " + error.message);
                    } finally {
                        setImageLoading(false);
                    }
                };

                const deleteImage = (index) => {
                    setGeneratedImages((prev) =>
                        prev.filter((_, i) => i !== index),
                    );
                };

                const downloadImage = async (url, index) => {
                    try {
                        const response = await fetch(url);
                        const blob = await response.blob();
                        const blobUrl = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = blobUrl;
                        a.download = `parley_image_${index}_${Date.now()}.png`;
                        a.click();
                        URL.revokeObjectURL(blobUrl);
                    } catch (error) {
                        alert("Failed to download image: " + error.message);
                    }
                };

                const clearAllImages = () => {
                    if (
                        confirm(
                            "Are you sure you want to delete all generated images?",
                        )
                    ) {
                        setGeneratedImages([]);
                    }
                };

                // Theme helper functions
                const bg = (normal, oled) => (oledMode ? oled : normal);
                const glass = (normal, oled) => (oledMode ? oled : normal);
                const textColor = (normal, oled) => (oledMode ? oled : normal);
                const roundedClass = (normal) => (oledMode ? "" : normal);

                return (
                    <div
                        className={`flex flex-col h-full ${bg("bg-gray-900", "bg-black")} ${textColor("text-gray-100", "text-gray-500")}`}
                    >
                        <div
                            className={`${glass("glass", "glass-oled")} border-b ${bg("border-gray-700/30", "border-gray-900")} p-3 sm:p-4 flex justify-between items-center flex-wrap sm:flex-nowrap gap-2 ${roundedClass("rounded-b-3xl")}`}
                        >
                            <div className="flex items-center gap-2 sm:gap-3 min-w-0 flex-shrink">
                                <h1
                                    className={`text-sm sm:text-lg font-mono whitespace-nowrap font-bold tracking-wider ${textColor("", "text-gray-600")}`}
                                >
                                    PARLEY
                                </h1>
                                {mode === "chat" && (
                                    <div className="flex items-center gap-1 sm:gap-2 min-w-0">
                                        <span className="text-xs text-gray-500 font-mono hidden sm:inline">
                                            BRANCH:
                                        </span>
                                        <select
                                            value={currentBranch}
                                            onChange={(e) =>
                                                setCurrentBranch(e.target.value)
                                            }
                                            className={`${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-2 sm:px-3 py-1.5 text-xs font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} min-w-0 max-w-[120px] sm:max-w-none transition-all ${textColor("", "text-gray-500")}`}
                                        >
                                            {Object.keys(branches).map(
                                                (branchName) => (
                                                    <option
                                                        key={branchName}
                                                        value={branchName}
                                                    >
                                                        {branchName} (
                                                        {
                                                            branches[branchName]
                                                                .length
                                                        }
                                                        )
                                                    </option>
                                                ),
                                            )}
                                        </select>
                                        {currentBranch !== "main" && (
                                            <button
                                                onClick={() =>
                                                    deleteBranch(currentBranch)
                                                }
                                                className={`px-2 sm:px-3 py-1.5 bg-red-900/80 hover:bg-red-800 border border-red-700/50 text-xs font-mono whitespace-nowrap ${roundedClass("rounded-xl")} transition-all ${roundedClass("backdrop-blur-sm")} text-gray-300`}
                                            >
                                                DEL
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                            <div className="flex gap-2 flex-shrink-0">
                                <button
                                    onClick={() =>
                                        setMode(
                                            mode === "chat" ? "image" : "chat",
                                        )
                                    }
                                    className={`px-3 sm:px-4 py-1.5 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs sm:text-sm font-mono ${roundedClass("rounded-xl")} transition-all ${mode === "image" ? "text-purple-400 ring-2 ring-purple-500/50" : textColor("", "text-gray-500")}`}
                                >
                                    <span className="hidden sm:inline">
                                        {mode === "chat" ? "IMAGE" : "CHAT"}
                                    </span>
                                    <span className="sm:hidden">
                                        {mode === "chat" ? "" : ""}
                                    </span>
                                </button>
                                <button
                                    onClick={() => setOledMode(!oledMode)}
                                    className={`px-3 sm:px-4 py-1.5 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs sm:text-sm font-mono ${roundedClass("rounded-xl")} transition-all ${oledMode ? "text-green-500 ring-2 ring-green-500/50" : ""}`}
                                >
                                    <span className="hidden sm:inline">
                                        OLED
                                    </span>
                                    <span className="sm:hidden">O</span>
                                </button>
                                {mode === "chat" && (
                                    <button
                                        onClick={() =>
                                            setShowSearch(!showSearch)
                                        }
                                        className={`px-3 sm:px-4 py-1.5 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs sm:text-sm font-mono ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                    >
                                        <span className="hidden sm:inline">
                                            {showSearch ? "HIDE" : "SEARCH"}
                                        </span>
                                        <span className="sm:hidden">S</span>
                                    </button>
                                )}
                                <button
                                    onClick={() =>
                                        setShowSettings(!showSettings)
                                    }
                                    className={`px-3 sm:px-4 py-1.5 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs sm:text-sm font-mono ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                >
                                    <span className="hidden sm:inline">
                                        {showSettings ? "HIDE" : "SETTINGS"}
                                    </span>
                                    <span className="sm:hidden"></span>
                                </button>
                            </div>
                        </div>

                        {mode === "chat" && showSearch && (
                            <div
                                className={`${glass("glass", "glass-oled")} border-b ${bg("border-gray-700/30", "border-gray-900")} p-3 sm:p-4`}
                            >
                                <div className="flex gap-2 items-center">
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={(e) =>
                                            setSearchQuery(e.target.value)
                                        }
                                        placeholder="Search messages..."
                                        className={`flex-1 ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 sm:px-4 py-2 text-xs sm:text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} transition-all ${textColor("", "text-gray-500")}`}
                                    />
                                    {searchResults.length > 0 && (
                                        <>
                                            <span
                                                className={`text-xs font-mono text-gray-500 whitespace-nowrap px-2 py-1 ${roundedClass("rounded-lg")} bg-gray-800/30`}
                                            >
                                                {currentSearchIndex + 1}/
                                                {searchResults.length}
                                            </span>
                                            <button
                                                onClick={prevSearchResult}
                                                className={`px-3 sm:px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                            >
                                                
                                            </button>
                                            <button
                                                onClick={nextSearchResult}
                                                className={`px-3 sm:px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                            >
                                                
                                            </button>
                                        </>
                                    )}
                                    <button
                                        onClick={() => {
                                            setSearchQuery("");
                                            setShowSearch(false);
                                        }}
                                        className={`px-3 sm:px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono whitespace-nowrap ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                    >
                                        CLR
                                    </button>
                                </div>
                            </div>
                        )}

                        {showSettings && mode === "chat" && (
                            <div
                                className={`${glass("glass", "glass-oled")} border-b ${bg("border-gray-700/30", "border-gray-900")} p-3 sm:p-4 space-y-4 max-h-96 overflow-y-auto scroll-container`}
                            >
                                <div>
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        CHARACTER TEMPLATE
                                    </label>
                                    <div className="flex gap-2 mb-2">
                                        <select
                                            value={selectedTemplate}
                                            onChange={(e) =>
                                                loadTemplate(e.target.value)
                                            }
                                            className={`flex-1 ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} transition-all ${textColor("", "text-gray-500")}`}
                                        >
                                            {allTemplates.map((template) => (
                                                <option
                                                    key={template.name}
                                                    value={template.name}
                                                >
                                                    {template.name}
                                                </option>
                                            ))}
                                        </select>
                                        {customTemplates.some(
                                            (t) => t.name === selectedTemplate,
                                        ) && (
                                            <button
                                                onClick={() =>
                                                    deleteCustomTemplate(
                                                        selectedTemplate,
                                                    )
                                                }
                                                className={`px-4 py-2 bg-red-900/80 hover:bg-red-800 border border-red-700/50 text-xs font-mono whitespace-nowrap ${roundedClass("rounded-xl")} transition-all ${roundedClass("backdrop-blur-sm")} text-gray-300`}
                                            >
                                                DELETE
                                            </button>
                                        )}
                                    </div>

                                    <div
                                        className={`flex gap-2 pt-3 border-t ${bg("border-gray-700/30", "border-gray-900")}`}
                                    >
                                        <input
                                            type="text"
                                            value={newTemplateName}
                                            onChange={(e) =>
                                                setNewTemplateName(
                                                    e.target.value,
                                                )
                                            }
                                            className={`flex-1 ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-xs font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} transition-all ${textColor("", "text-gray-500")}`}
                                            placeholder="New template name..."
                                        />
                                        <button
                                            onClick={saveCustomTemplate}
                                            disabled={!newTemplateName.trim()}
                                            className={`px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono disabled:opacity-50 whitespace-nowrap ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                        >
                                            SAVE AS
                                        </button>
                                    </div>
                                </div>

                                <div
                                    className={`border-t ${bg("border-gray-700/30", "border-gray-900")} pt-4`}
                                >
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        API KEY (OpenRouter)
                                    </label>
                                    <input
                                        type="password"
                                        value={apiKey}
                                        onChange={(e) =>
                                            setApiKey(e.target.value)
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} transition-all ${textColor("", "text-gray-500")}`}
                                        placeholder="sk-or-v1-..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        MODEL ENDPOINT
                                    </label>
                                    <input
                                        type="text"
                                        value={model}
                                        onChange={(e) =>
                                            setModel(e.target.value)
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} transition-all ${textColor("", "text-gray-500")}`}
                                        placeholder="anthropic/claude-3.5-sonnet"
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        SAVED MODELS
                                    </label>
                                    {savedModels.length > 0 && (
                                        <div className="space-y-2 mb-3">
                                            {savedModels.map((savedModel, idx) => (
                                                <div
                                                    key={idx}
                                                    className={`flex items-center gap-2 ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2`}
                                                >
                                                    <div className="flex-1 min-w-0">
                                                        <div className={`text-xs font-mono font-bold ${textColor("text-gray-300", "text-gray-600")}`}>
                                                            {savedModel.name}
                                                        </div>
                                                        <div className="text-xs font-mono text-gray-500 truncate">
                                                            {savedModel.endpoint}
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={() =>
                                                            loadSavedModel(
                                                                savedModel.endpoint,
                                                            )
                                                        }
                                                        className={`px-3 py-1.5 bg-blue-900/80 hover:bg-blue-800 border border-blue-700/50 text-xs font-mono whitespace-nowrap ${roundedClass("rounded-lg")} transition-all ${roundedClass("backdrop-blur-sm")} text-gray-300`}
                                                    >
                                                        LOAD
                                                    </button>
                                                    <button
                                                        onClick={() =>
                                                            deleteSavedModel(
                                                                savedModel.name,
                                                            )
                                                        }
                                                        className={`px-3 py-1.5 bg-red-900/80 hover:bg-red-800 border border-red-700/50 text-xs font-mono whitespace-nowrap ${roundedClass("rounded-lg")} transition-all ${roundedClass("backdrop-blur-sm")} text-gray-300`}
                                                    >
                                                        DEL
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    <div
                                        className={`flex gap-2 ${savedModels.length > 0 ? `pt-3 border-t ${bg("border-gray-700/30", "border-gray-900")}` : ""}`}
                                    >
                                        <input
                                            type="text"
                                            value={newModelName}
                                            onChange={(e) =>
                                                setNewModelName(e.target.value)
                                            }
                                            className={`flex-1 ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-xs font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} transition-all ${textColor("", "text-gray-500")}`}
                                            placeholder="Name for current model..."
                                        />
                                        <button
                                            onClick={saveCurrentModel}
                                            disabled={!newModelName.trim()}
                                            className={`px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono disabled:opacity-50 whitespace-nowrap ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                        >
                                            SAVE
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        SYSTEM PROMPT
                                    </label>
                                    <textarea
                                        value={systemPrompt}
                                        onChange={(e) => {
                                            setSystemPrompt(e.target.value);
                                            setSelectedTemplate("CUSTOM");
                                        }}
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} h-24 resize-none transition-all ${textColor("", "text-gray-500")}`}
                                        placeholder="Define the character or scenario..."
                                    />
                                </div>

                                <div
                                    className={`border-t ${bg("border-gray-700/30", "border-gray-900")} pt-4 space-y-4`}
                                >
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-mono text-gray-500 mb-2">
                                                TEMPERATURE:{" "}
                                                {temperature.toFixed(2)}
                                            </label>
                                            <input
                                                type="range"
                                                min="0"
                                                max="2"
                                                step="0.1"
                                                value={temperature}
                                                onChange={(e) =>
                                                    setTemperature(
                                                        parseFloat(
                                                            e.target.value,
                                                        ),
                                                    )
                                                }
                                                className="w-full"
                                            />
                                            <div className="text-xs font-mono text-gray-600 mt-1">
                                                0=precise, 2=creative
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-mono text-gray-500 mb-2">
                                                MAX TOKENS: {maxTokens}
                                            </label>
                                            <input
                                                type="range"
                                                min="100"
                                                max="4000"
                                                step="100"
                                                value={maxTokens}
                                                onChange={(e) =>
                                                    setMaxTokens(
                                                        parseInt(
                                                            e.target.value,
                                                        ),
                                                    )
                                                }
                                                className="w-full"
                                            />
                                            <div className="text-xs font-mono text-gray-600 mt-1">
                                                response length limit
                                            </div>
                                        </div>
                                    </div>

                                    <button
                                        onClick={() =>
                                            setShowAdvanced(!showAdvanced)
                                        }
                                        className={`w-full px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                    >
                                        {showAdvanced ? "" : ""} ADVANCED
                                        PARAMETERS
                                    </button>

                                    {showAdvanced && (
                                        <div
                                            className={`space-y-4 pl-4 border-l-2 ${bg("border-gray-700/30", "border-gray-900")} ${roundedClass("rounded-l-xl")}`}
                                        >
                                            <div>
                                                <label className="block text-xs font-mono text-gray-500 mb-2">
                                                    TOP P: {topP.toFixed(2)}
                                                </label>
                                                <input
                                                    type="range"
                                                    min="0"
                                                    max="1"
                                                    step="0.05"
                                                    value={topP}
                                                    onChange={(e) =>
                                                        setTopP(
                                                            parseFloat(
                                                                e.target.value,
                                                            ),
                                                        )
                                                    }
                                                    className="w-full"
                                                />
                                                <div className="text-xs font-mono text-gray-600 mt-1">
                                                    nucleus sampling
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-mono text-gray-500 mb-2">
                                                    FREQ PENALTY:{" "}
                                                    {frequencyPenalty.toFixed(
                                                        2,
                                                    )}
                                                </label>
                                                <input
                                                    type="range"
                                                    min="-2"
                                                    max="2"
                                                    step="0.1"
                                                    value={frequencyPenalty}
                                                    onChange={(e) =>
                                                        setFrequencyPenalty(
                                                            parseFloat(
                                                                e.target.value,
                                                            ),
                                                        )
                                                    }
                                                    className="w-full"
                                                />
                                                <div className="text-xs font-mono text-gray-600 mt-1">
                                                    reduce repetition
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-mono text-gray-500 mb-2">
                                                    PRESENCE PENALTY:{" "}
                                                    {presencePenalty.toFixed(2)}
                                                </label>
                                                <input
                                                    type="range"
                                                    min="-2"
                                                    max="2"
                                                    step="0.1"
                                                    value={presencePenalty}
                                                    onChange={(e) =>
                                                        setPresencePenalty(
                                                            parseFloat(
                                                                e.target.value,
                                                            ),
                                                        )
                                                    }
                                                    className="w-full"
                                                />
                                                <div className="text-xs font-mono text-gray-600 mt-1">
                                                    encourage new topics
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="flex gap-2">
                                    <button
                                        onClick={() => updateMessages([])}
                                        className={`flex-1 px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                    >
                                        CLEAR CHAT
                                    </button>
                                    <button
                                        onClick={clearAllData}
                                        className={`flex-1 px-4 py-2 bg-red-900/80 hover:bg-red-800 border border-red-700/50 text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${roundedClass("backdrop-blur-sm")} text-gray-300`}
                                    >
                                        RESET ALL
                                    </button>
                                </div>

                                <div
                                    className={`border-t ${bg("border-gray-700/30", "border-gray-900")} pt-4 space-y-2`}
                                >
                                    <div className="text-xs font-mono text-gray-500 mb-3">
                                        CONVERSATION DATA
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() =>
                                                exportConversation("json")
                                            }
                                            className={`flex-1 px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                            disabled={messages.length === 0}
                                        >
                                            EXPORT JSON
                                        </button>
                                        <button
                                            onClick={() =>
                                                exportConversation("markdown")
                                            }
                                            className={`flex-1 px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                            disabled={messages.length === 0}
                                        >
                                            EXPORT MD
                                        </button>
                                    </div>
                                    <div>
                                        <input
                                            type="file"
                                            accept=".json"
                                            onChange={importConversation}
                                            className="hidden"
                                            id="import-file"
                                        />
                                        <label
                                            htmlFor="import-file"
                                            className={`block w-full px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono text-center cursor-pointer ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                        >
                                            IMPORT JSON
                                        </label>
                                    </div>
                                </div>

                                <div
                                    className={`border-t ${bg("border-gray-700/30", "border-gray-900")} pt-4 space-y-2`}
                                >
                                    <div className="text-xs font-mono text-gray-500 mb-3">
                                        CHARACTER CARDS
                                    </div>
                                    <div className="flex gap-2">
                                        <input
                                            type="file"
                                            accept=".png,.json"
                                            onChange={importCharacterCard}
                                            className="hidden"
                                            id="import-character"
                                        />
                                        <label
                                            htmlFor="import-character"
                                            className={`flex-1 px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono text-center cursor-pointer ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                        >
                                            IMPORT CARD
                                        </label>
                                        <button
                                            onClick={createCharacterCard}
                                            className={`flex-1 px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                        >
                                            CREATE CARD
                                        </button>
                                    </div>
                                    {characterCard && (
                                        <div className="flex gap-2">
                                            <button
                                                onClick={applyCharacterCard}
                                                className={`flex-1 px-4 py-2 bg-green-900/80 hover:bg-green-800 border border-green-700/50 text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${roundedClass("backdrop-blur-sm")} text-gray-300`}
                                            >
                                                APPLY TO CHAT
                                            </button>
                                            <button
                                                onClick={exportCharacterCard}
                                                className={`flex-1 px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                            >
                                                EXPORT CARD
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {showSettings && mode === "image" && (
                            <div
                                className={`${glass("glass", "glass-oled")} border-b ${bg("border-gray-700/30", "border-gray-900")} p-3 sm:p-4 space-y-4 max-h-96 overflow-y-auto scroll-container`}
                            >
                                <div>
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        IMAGE PROVIDER
                                    </label>
                                    <select
                                        value={imageProvider}
                                        onChange={(e) =>
                                            setImageProvider(e.target.value)
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} transition-all ${textColor("", "text-gray-500")}`}
                                    >
                                        <option value="fal">FAL.ai</option>
                                        <option value="replicate">
                                            Replicate
                                        </option>
                                    </select>
                                </div>

                                {imageProvider === "fal" && (
                                    <>
                                        <div>
                                            <label className="block text-xs font-mono text-gray-500 mb-2">
                                                FAL API KEY
                                            </label>
                                            <input
                                                type="password"
                                                value={falApiKey}
                                                onChange={(e) =>
                                                    setFalApiKey(e.target.value)
                                                }
                                                className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} transition-all ${textColor("", "text-gray-500")}`}
                                                placeholder="Get your key from fal.ai"
                                            />
                                            <div className="text-xs font-mono text-gray-600 mt-1">
                                                Sign up at{" "}
                                                <a
                                                    href="https://fal.ai"
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="text-blue-400 hover:underline"
                                                >
                                                    fal.ai
                                                </a>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-mono text-gray-500 mb-2">
                                                IMAGE MODEL
                                            </label>
                                            <select
                                                value={imageModel}
                                                onChange={(e) =>
                                                    setImageModel(e.target.value)
                                                }
                                                className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} transition-all ${textColor("", "text-gray-500")}`}
                                            >
                                                <option value="fal-ai/flux/schnell">
                                                    FLUX Schnell (Fast)
                                                </option>
                                                <option value="fal-ai/flux/dev">
                                                    FLUX Dev (Quality)
                                                </option>
                                                <option value="fal-ai/flux-pro">
                                                    FLUX Pro (Best)
                                                </option>
                                                <option value="fal-ai/fast-sdxl">
                                                    Fast SDXL
                                                </option>
                                            </select>
                                        </div>
                                    </>
                                )}

                                {imageProvider === "replicate" && (
                                    <>
                                        <div>
                                            <label className="block text-xs font-mono text-gray-500 mb-2">
                                                REPLICATE API KEY
                                            </label>
                                            <input
                                                type="password"
                                                value={replicateApiKey}
                                                onChange={(e) =>
                                                    setReplicateApiKey(
                                                        e.target.value,
                                                    )
                                                }
                                                className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} transition-all ${textColor("", "text-gray-500")}`}
                                                placeholder="Get your key from replicate.com"
                                            />
                                            <div className="text-xs font-mono text-gray-600 mt-1">
                                                Sign up at{" "}
                                                <a
                                                    href="https://replicate.com"
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="text-blue-400 hover:underline"
                                                >
                                                    replicate.com
                                                </a>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-mono text-gray-500 mb-2">
                                                MODEL VERSION ID
                                            </label>
                                            <input
                                                type="text"
                                                value={imageModel}
                                                onChange={(e) =>
                                                    setImageModel(e.target.value)
                                                }
                                                className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} transition-all ${textColor("", "text-gray-500")}`}
                                                placeholder="e.g., black-forest-labs/flux-schnell"
                                            />
                                            <div className="text-xs font-mono text-gray-600 mt-1">
                                                Popular models: black-forest-labs/flux-schnell, stability-ai/sdxl
                                            </div>
                                        </div>
                                    </>
                                )}

                                <div>
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        IMAGE SIZE
                                    </label>
                                    <select
                                        value={imageSize}
                                        onChange={(e) =>
                                            setImageSize(e.target.value)
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} transition-all ${textColor("", "text-gray-500")}`}
                                    >
                                        <option value="square_hd">
                                            Square HD (1024x1024)
                                        </option>
                                        <option value="square">
                                            Square (512x512)
                                        </option>
                                        <option value="portrait_4_3">
                                            Portrait 4:3 (768x1024)
                                        </option>
                                        <option value="portrait_16_9">
                                            Portrait 16:9 (576x1024)
                                        </option>
                                        <option value="landscape_4_3">
                                            Landscape 4:3 (1024x768)
                                        </option>
                                        <option value="landscape_16_9">
                                            Landscape 16:9 (1024x576)
                                        </option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        INFERENCE STEPS: {numInferenceSteps}
                                    </label>
                                    <input
                                        type="range"
                                        min="1"
                                        max="50"
                                        step="1"
                                        value={numInferenceSteps}
                                        onChange={(e) =>
                                            setNumInferenceSteps(
                                                parseInt(e.target.value),
                                            )
                                        }
                                        className="w-full"
                                    />
                                    <div className="text-xs font-mono text-gray-600 mt-1">
                                        more steps = better quality (slower)
                                    </div>
                                </div>

                                {imageModel !== "fal-ai/flux/schnell" && (
                                    <div>
                                        <label className="block text-xs font-mono text-gray-500 mb-2">
                                            GUIDANCE SCALE:{" "}
                                            {guidanceScale.toFixed(1)}
                                        </label>
                                        <input
                                            type="range"
                                            min="1"
                                            max="20"
                                            step="0.5"
                                            value={guidanceScale}
                                            onChange={(e) =>
                                                setGuidanceScale(
                                                    parseFloat(e.target.value),
                                                )
                                            }
                                            className="w-full"
                                        />
                                        <div className="text-xs font-mono text-gray-600 mt-1">
                                            how closely to follow prompt
                                        </div>
                                    </div>
                                )}

                                <div>
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        NUM IMAGES: {numImages}
                                    </label>
                                    <input
                                        type="range"
                                        min="1"
                                        max="4"
                                        step="1"
                                        value={numImages}
                                        onChange={(e) =>
                                            setNumImages(
                                                parseInt(e.target.value),
                                            )
                                        }
                                        className="w-full"
                                    />
                                    <div className="text-xs font-mono text-gray-600 mt-1">
                                        generate multiple images at once
                                    </div>
                                </div>

                                <div className="flex gap-2">
                                    <button
                                        onClick={clearAllImages}
                                        className={`flex-1 px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                        disabled={generatedImages.length === 0}
                                    >
                                        CLEAR GALLERY
                                    </button>
                                </div>
                            </div>
                        )}

                        {showCharacterCard && characterCard && (
                            <div
                                className={`${glass("glass", "glass-oled")} border-b ${bg("border-gray-700/30", "border-gray-900")} p-3 sm:p-4 space-y-4 max-h-96 overflow-y-auto scroll-container`}
                            >
                                <div className="flex justify-between items-center mb-2">
                                    <div
                                        className={`text-xs sm:text-sm font-mono font-bold ${textColor("text-gray-300", "text-gray-600")}`}
                                    >
                                        CHARACTER CARD EDITOR
                                    </div>
                                    <button
                                        onClick={() =>
                                            setShowCharacterCard(false)
                                        }
                                        className={`px-3 py-1.5 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                    >
                                        CLOSE
                                    </button>
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        CHARACTER NAME
                                    </label>
                                    <input
                                        type="text"
                                        value={characterCard.data?.name || ""}
                                        onChange={(e) =>
                                            updateCharacterCardField(
                                                "name",
                                                e.target.value,
                                            )
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} transition-all ${textColor("", "text-gray-500")}`}
                                        placeholder="Character name..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        DESCRIPTION
                                    </label>
                                    <textarea
                                        value={
                                            characterCard.data?.description ||
                                            ""
                                        }
                                        onChange={(e) =>
                                            updateCharacterCardField(
                                                "description",
                                                e.target.value,
                                            )
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} h-20 resize-none transition-all ${textColor("", "text-gray-500")}`}
                                        placeholder="Physical appearance, background..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        PERSONALITY
                                    </label>
                                    <textarea
                                        value={
                                            characterCard.data?.personality ||
                                            ""
                                        }
                                        onChange={(e) =>
                                            updateCharacterCardField(
                                                "personality",
                                                e.target.value,
                                            )
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} h-20 resize-none transition-all ${textColor("", "text-gray-500")}`}
                                        placeholder="Personality traits, mannerisms..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        SCENARIO
                                    </label>
                                    <textarea
                                        value={
                                            characterCard.data?.scenario || ""
                                        }
                                        onChange={(e) =>
                                            updateCharacterCardField(
                                                "scenario",
                                                e.target.value,
                                            )
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} h-20 resize-none transition-all ${textColor("", "text-gray-500")}`}
                                        placeholder="Setting, situation, context..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        FIRST MESSAGE
                                    </label>
                                    <textarea
                                        value={
                                            characterCard.data?.first_mes || ""
                                        }
                                        onChange={(e) =>
                                            updateCharacterCardField(
                                                "first_mes",
                                                e.target.value,
                                            )
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} h-20 resize-none transition-all ${textColor("", "text-gray-500")}`}
                                        placeholder="Character's opening message..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-500 mb-2">
                                        EXAMPLE DIALOGUE
                                    </label>
                                    <textarea
                                        value={
                                            characterCard.data?.mes_example ||
                                            ""
                                        }
                                        onChange={(e) =>
                                            updateCharacterCardField(
                                                "mes_example",
                                                e.target.value,
                                            )
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-2 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} h-24 resize-none transition-all ${textColor("", "text-gray-500")}`}
                                        placeholder="<START>
            {{user}}: Hello!
            {{char}}: Hi there!"
                                    />
                                </div>

                                <div
                                    className={`flex gap-2 pt-3 border-t ${bg("border-gray-700/30", "border-gray-900")}`}
                                >
                                    <button
                                        onClick={applyCharacterCard}
                                        className={`flex-1 px-4 py-2 bg-green-900/80 hover:bg-green-800 border border-green-700/50 text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${roundedClass("backdrop-blur-sm")} text-gray-300`}
                                    >
                                        APPLY TO CHAT
                                    </button>
                                    <button
                                        onClick={exportCharacterCard}
                                        className={`flex-1 px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                    >
                                        EXPORT JSON
                                    </button>
                                </div>
                            </div>
                        )}

                        {mode === "chat" ? (
                            <>
                                <div className="flex-1 overflow-y-auto p-3 sm:p-4 space-y-3 scroll-container">
                                    {messages.map((msg, idx) => {
                                        const isSearchResult =
                                            searchResults.includes(idx);
                                        const isCurrentResult =
                                            searchResults[
                                                currentSearchIndex
                                            ] === idx;

                                        return (
                                            <div
                                                key={idx}
                                                className="group"
                                                ref={(el) =>
                                                    (searchResultRefs.current[
                                                        idx
                                                    ] = el)
                                                }
                                            >
                                                <div className="flex justify-between items-start mb-2">
                                                    <div className="text-xs font-mono opacity-60 flex items-center gap-2">
                                                        {msg.role.toUpperCase()}{" "}
                                                        #{idx}
                                                        {isSearchResult && (
                                                            <span
                                                                className={`text-xs font-mono ${isCurrentResult ? "text-yellow-400" : "text-gray-500"}`}
                                                            >
                                                                {isCurrentResult
                                                                    ? " CURRENT"
                                                                    : ""}
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                                                        {msg.role ===
                                                            "user" && (
                                                            <button
                                                                onClick={() =>
                                                                    startEdit(
                                                                        idx,
                                                                    )
                                                                }
                                                                className={`px-2 py-1 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono ${roundedClass("rounded-lg")} transition-all ${textColor("", "text-gray-500")}`}
                                                                disabled={
                                                                    loading
                                                                }
                                                            >
                                                                EDIT
                                                            </button>
                                                        )}
                                                        {msg.role ===
                                                            "assistant" &&
                                                            idx ===
                                                                messages.length -
                                                                    1 && (
                                                                <button
                                                                    onClick={() =>
                                                                        regenerateMessage(
                                                                            idx,
                                                                        )
                                                                    }
                                                                    className={`px-2 py-1 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono ${roundedClass("rounded-lg")} transition-all ${textColor("", "text-gray-500")}`}
                                                                    disabled={
                                                                        loading
                                                                    }
                                                                >
                                                                    REGEN
                                                                </button>
                                                            )}
                                                        <button
                                                            onClick={() =>
                                                                forkBranch(idx)
                                                            }
                                                            className={`px-2 py-1 bg-blue-900/80 hover:bg-blue-800 border border-blue-700/50 text-xs font-mono ${roundedClass("rounded-lg")} transition-all ${roundedClass("backdrop-blur-sm")} text-gray-300`}
                                                            disabled={loading}
                                                        >
                                                            FORK
                                                        </button>
                                                        <button
                                                            onClick={() =>
                                                                deleteMessage(
                                                                    idx,
                                                                )
                                                            }
                                                            className={`px-2 py-1 bg-red-900/80 hover:bg-red-800 border border-red-700/50 text-xs font-mono ${roundedClass("rounded-lg")} transition-all ${roundedClass("backdrop-blur-sm")} text-gray-300`}
                                                            disabled={loading}
                                                        >
                                                            DEL
                                                        </button>
                                                    </div>
                                                </div>

                                                {editingIndex === idx ? (
                                                    <div className="space-y-2">
                                                        <textarea
                                                            value={editText}
                                                            onChange={(e) =>
                                                                setEditText(
                                                                    e.target
                                                                        .value,
                                                                )
                                                            }
                                                            className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-3 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} resize-none transition-all ${textColor("", "text-gray-500")}`}
                                                            rows="4"
                                                        />
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() =>
                                                                    saveEdit(
                                                                        idx,
                                                                    )
                                                                }
                                                                className={`px-4 py-2 bg-green-900/80 hover:bg-green-800 border border-green-700/50 text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${roundedClass("backdrop-blur-sm")} text-gray-300`}
                                                            >
                                                                SAVE
                                                            </button>
                                                            <button
                                                                onClick={
                                                                    cancelEdit
                                                                }
                                                                className={`px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-900")} text-xs font-mono ${roundedClass("rounded-xl")} transition-all ${textColor("", "text-gray-500")}`}
                                                            >
                                                                CANCEL
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div
                                                        className={`font-mono text-xs sm:text-sm whitespace-pre-wrap ${oledMode ? "px-0 py-2" : "px-4 py-3"} ${roundedClass("rounded-2xl")} ${
                                                            msg.role === "user"
                                                                ? oledMode
                                                                    ? "text-gray-600"
                                                                    : "text-blue-400 bg-blue-950/30 border border-blue-900/30"
                                                                : msg.role ===
                                                                    "assistant"
                                                                  ? oledMode
                                                                      ? "text-gray-500"
                                                                      : "text-green-400 bg-green-950/30 border border-green-900/30"
                                                                  : oledMode
                                                                    ? "text-gray-700"
                                                                    : "text-red-400 bg-red-950/30 border border-red-900/30"
                                                        } ${isCurrentResult && !oledMode ? `ring-2 ring-yellow-600/50` : ""} ${!oledMode ? "backdrop-blur-sm" : ""}`}
                                                    >
                                                        {searchQuery
                                                            ? highlightText(
                                                                  msg.content,
                                                                  searchQuery,
                                                              )
                                                                  .split(
                                                                      "<<HIGHLIGHT>>",
                                                                  )
                                                                  .map(
                                                                      (
                                                                          part,
                                                                          i,
                                                                      ) => {
                                                                          if (
                                                                              part.includes(
                                                                                  "<<ENDHIGHLIGHT>>",
                                                                              )
                                                                          ) {
                                                                              const [
                                                                                  highlighted,
                                                                                  ...rest
                                                                              ] =
                                                                                  part.split(
                                                                                      "<<ENDHIGHLIGHT>>",
                                                                                  );
                                                                              return (
                                                                                  <span
                                                                                      key={
                                                                                          i
                                                                                      }
                                                                                  >
                                                                                      <span
                                                                                          className={`bg-yellow-600 text-black font-bold ${roundedClass("px-1 rounded")}`}
                                                                                      >
                                                                                          {
                                                                                              highlighted
                                                                                          }
                                                                                      </span>
                                                                                      {rest.join(
                                                                                          "<<ENDHIGHLIGHT>>",
                                                                                      )}
                                                                                  </span>
                                                                              );
                                                                          }
                                                                          return (
                                                                              <span
                                                                                  key={
                                                                                      i
                                                                                  }
                                                                              >
                                                                                  {
                                                                                      part
                                                                                  }
                                                                              </span>
                                                                          );
                                                                      },
                                                                  )
                                                            : msg.content}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}

                                    {isStreaming && streamingText && (
                                        <div>
                                            <div className="text-xs font-mono mb-2 opacity-60">
                                                ASSISTANT #{messages.length}{" "}
                                                <span className="text-yellow-500">
                                                     STREAMING
                                                </span>
                                            </div>
                                            <div
                                                className={`font-mono text-xs sm:text-sm whitespace-pre-wrap ${oledMode ? "text-gray-500 px-0 py-2" : "text-green-400 px-4 py-3 rounded-2xl bg-green-950/30 border border-green-900/30 backdrop-blur-sm"}`}
                                            >
                                                {streamingText}
                                                <span className="animate-pulse">
                                                    
                                                </span>
                                            </div>
                                        </div>
                                    )}

                                    {loading && !streamingText && (
                                        <div
                                            className={`text-gray-500 font-mono text-sm ${oledMode ? "" : "px-4 py-3 rounded-2xl bg-gray-800/30 backdrop-blur-sm inline-block"}`}
                                        >
                                            CONNECTING...
                                        </div>
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>

                                <div
                                    className={`${glass("glass", "glass-oled")} border-t ${bg("border-gray-700/30", "border-gray-900")} p-3 sm:p-4 ${roundedClass("rounded-t-3xl")}`}
                                >
                                    <div className="flex gap-2">
                                        <textarea
                                            value={input}
                                            onChange={(e) =>
                                                setInput(e.target.value)
                                            }
                                            onKeyPress={handleKeyPress}
                                            className={`flex-1 ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-2xl")} px-3 sm:px-4 py-3 text-xs sm:text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} resize-none transition-all ${textColor("", "text-gray-500")}`}
                                            placeholder="Enter message... (Shift+Enter for new line)"
                                            rows="3"
                                            disabled={loading || !apiKey}
                                        />
                                        {isStreaming ? (
                                            <button
                                                onClick={stopGeneration}
                                                className={`px-4 sm:px-6 bg-red-900/80 hover:bg-red-800 border border-red-700/50 font-mono text-xs sm:text-sm whitespace-nowrap ${roundedClass("rounded-2xl")} transition-all ${roundedClass("backdrop-blur-sm")} text-gray-300`}
                                            >
                                                STOP
                                            </button>
                                        ) : (
                                            <button
                                                onClick={sendMessage}
                                                disabled={
                                                    loading ||
                                                    !apiKey ||
                                                    !input.trim()
                                                }
                                                className={`px-4 sm:px-6 ${glass("glass-light", "glass-light-oled")} hover:bg-blue-600/30 border ${bg("border-gray-600/30", "border-gray-900")} font-mono disabled:opacity-50 disabled:cursor-not-allowed text-xs sm:text-sm whitespace-nowrap ${roundedClass("rounded-2xl")} transition-all ${textColor("", "text-gray-500")}`}
                                            >
                                                SEND
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </>
                        ) : (
                            <>
                                <div className="flex-1 overflow-y-auto p-3 sm:p-4 space-y-4 scroll-container">
                                    <div
                                        className={`${glass("glass", "glass-oled")} ${roundedClass("rounded-2xl")} p-4 sm:p-6 border ${bg("border-gray-700/30", "border-gray-900")}`}
                                    >
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-xs font-mono text-gray-500 mb-2">
                                                    PROMPT
                                                </label>
                                                <textarea
                                                    value={imagePrompt}
                                                    onChange={(e) =>
                                                        setImagePrompt(
                                                            e.target.value,
                                                        )
                                                    }
                                                    className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-3 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} resize-none transition-all ${textColor("", "text-gray-500")}`}
                                                    placeholder="Describe the image you want to generate..."
                                                    rows="4"
                                                    disabled={imageLoading}
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-xs font-mono text-gray-500 mb-2">
                                                    NEGATIVE PROMPT (OPTIONAL)
                                                </label>
                                                <textarea
                                                    value={negativePrompt}
                                                    onChange={(e) =>
                                                        setNegativePrompt(
                                                            e.target.value,
                                                        )
                                                    }
                                                    className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-900")} ${roundedClass("rounded-xl")} px-3 py-3 text-sm font-mono focus:outline-none ${roundedClass("focus:ring-2 focus:ring-blue-500/50")} resize-none transition-all ${textColor("", "text-gray-500")}`}
                                                    placeholder="What to avoid in the image..."
                                                    rows="2"
                                                    disabled={imageLoading}
                                                />
                                            </div>

                                            <button
                                                onClick={generateImage}
                                                disabled={
                                                    imageLoading ||
                                                    !falApiKey ||
                                                    !imagePrompt.trim()
                                                }
                                                className={`w-full px-6 py-3 bg-purple-900/80 hover:bg-purple-800 border border-purple-700/50 font-mono text-sm disabled:opacity-50 disabled:cursor-not-allowed ${roundedClass("rounded-2xl")} transition-all ${roundedClass("backdrop-blur-sm")} text-gray-300`}
                                            >
                                                {imageLoading
                                                    ? "GENERATING..."
                                                    : "GENERATE IMAGE"}
                                            </button>
                                        </div>
                                    </div>

                                    {generatedImages.length > 0 && (
                                        <div>
                                            <div className="flex justify-between items-center mb-3">
                                                <div
                                                    className={`text-xs sm:text-sm font-mono font-bold ${textColor("text-gray-300", "text-gray-600")}`}
                                                >
                                                    GENERATED IMAGES (
                                                    {generatedImages.length})
                                                </div>
                                            </div>

                                            <div className="image-grid">
                                                {generatedImages.map(
                                                    (img, idx) => (
                                                        <div
                                                            key={idx}
                                                            className={`${glass("glass", "glass-oled")} ${roundedClass("rounded-2xl")} overflow-hidden border ${bg("border-gray-700/30", "border-gray-900")} group`}
                                                        >
                                                            <div className="relative">
                                                                <img
                                                                    src={
                                                                        img.url
                                                                    }
                                                                    alt={`Generated ${idx}`}
                                                                    className="w-full h-auto"
                                                                    loading="lazy"
                                                                />
                                                                <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                                                                    <button
                                                                        onClick={() =>
                                                                            downloadImage(
                                                                                img.url,
                                                                                idx,
                                                                            )
                                                                        }
                                                                        className={`px-3 py-2 bg-blue-900/80 hover:bg-blue-800 border border-blue-700/50 text-xs font-mono ${roundedClass("rounded-lg")} transition-all ${roundedClass("backdrop-blur-sm")} text-gray-300`}
                                                                    >
                                                                        DOWNLOAD
                                                                    </button>
                                                                    <button
                                                                        onClick={() =>
                                                                            deleteImage(
                                                                                idx,
                                                                            )
                                                                        }
                                                                        className={`px-3 py-2 bg-red-900/80 hover:bg-red-800 border border-red-700/50 text-xs font-mono ${roundedClass("rounded-lg")} transition-all ${roundedClass("backdrop-blur-sm")} text-gray-300`}
                                                                    >
                                                                        DELETE
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div className="p-3">
                                                                <div className="text-xs font-mono text-gray-500 mb-1">
                                                                    {img.provider === "fal"
                                                                        ? img.model.split("/")[1] || img.model
                                                                        : img.model.split("/")[0] || img.model}{" "}
                                                                     {img.provider === "fal" ? "FAL" : "Replicate"}
                                                                </div>
                                                                <div
                                                                    className={`text-xs font-mono ${textColor("text-gray-400", "text-gray-600")} line-clamp-2`}
                                                                >
                                                                    {img.prompt}
                                                                </div>
                                                                <div className="text-xs font-mono text-gray-600 mt-2">
                                                                    {
                                                                        img
                                                                            .settings
                                                                            .size
                                                                    }{" "}
                                                                    {" "}
                                                                    {
                                                                        img
                                                                            .settings
                                                                            .steps
                                                                    }{" "}
                                                                    steps
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ),
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {imageLoading && (
                                        <div
                                            className={`${glass("glass", "glass-oled")} ${roundedClass("rounded-2xl")} p-6 border ${bg("border-gray-700/30", "border-gray-900")} text-center`}
                                        >
                                            <div
                                                className={`text-sm font-mono ${textColor("text-gray-300", "text-gray-600")}`}
                                            >
                                                GENERATING IMAGE...
                                            </div>
                                            <div className="text-xs font-mono text-gray-600 mt-2">
                                                This may take a few moments
                                            </div>
                                        </div>
                                    )}

                                    {generatedImages.length === 0 &&
                                        !imageLoading && (
                                            <div
                                                className={`${glass("glass", "glass-oled")} ${roundedClass("rounded-2xl")} p-6 border ${bg("border-gray-700/30", "border-gray-900")} text-center`}
                                            >
                                                <div
                                                    className={`text-sm font-mono ${textColor("text-gray-400", "text-gray-600")}`}
                                                >
                                                    NO IMAGES GENERATED YET
                                                </div>
                                                <div className="text-xs font-mono text-gray-600 mt-2">
                                                    Enter a prompt above to
                                                    start generating
                                                </div>
                                            </div>
                                        )}
                                </div>
                            </>
                        )}
                    </div>
                );
            }

            ReactDOM.render(<ParleyChat />, document.getElementById("root"));
        </script>
    </body>
</html>
