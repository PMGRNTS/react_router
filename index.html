<!doctype html>

<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta
            name="apple-mobile-web-app-status-bar-style"
            content="black-translucent"
        />
        <title>Parley Chat</title>
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.production.min.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            * {
                -webkit-tap-highlight-color: transparent;
            }

            html {
                background: #000;
                overscroll-behavior: none;
                -webkit-overflow-scrolling: touch;
            }

            body {
                margin: 0;
                padding: 0;
                background: #000;
                overscroll-behavior: none;
                position: fixed;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            #root {
                background: #000;
                height: 100%;
                overscroll-behavior: none;
            }

            .scroll-container {
                overscroll-behavior: contain;
                -webkit-overflow-scrolling: touch;
            }

            .glass {
                background: rgba(17, 24, 39, 0.7);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
            }

            .glass-light {
                background: rgba(31, 41, 55, 0.5);
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
            }

            .glass-oled {
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
            }

            .glass-light-oled {
                background: rgba(17, 17, 17, 0.6);
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
            }

            input[type="range"] {
                -webkit-appearance: none;
                appearance: none;
                background: transparent;
                cursor: pointer;
            }

            input[type="range"]::-webkit-slider-track {
                background: rgba(75, 85, 99, 0.5);
                height: 0.5rem;
                border-radius: 0.5rem;
            }

            input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                height: 1.25rem;
                width: 1.25rem;
                border-radius: 50%;
                background: rgb(96, 165, 250);
                cursor: pointer;
                margin-top: -0.375rem;
            }

            input[type="range"]::-moz-range-track {
                background: rgba(75, 85, 99, 0.5);
                height: 0.5rem;
                border-radius: 0.5rem;
            }

            input[type="range"]::-moz-range-thumb {
                height: 1.25rem;
                width: 1.25rem;
                border-radius: 50%;
                background: rgb(96, 165, 250);
                cursor: pointer;
                border: none;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useRef, useEffect } = React;

            const DEFAULT_TEMPLATES = [
                {
                    name: "CUSTOM",
                    systemPrompt: "You are a helpful assistant.",
                    model: "anthropic/claude-3.5-sonnet",
                },
                {
                    name: "DUNGEON MASTER",
                    systemPrompt:
                        "You are an expert dungeon master running a fantasy RPG campaign. Describe scenes vividly, respond to player actions dynamically, and maintain consistent world rules. Keep track of inventory, stats, and consequences.",
                    model: "anthropic/claude-3.5-sonnet",
                },
                {
                    name: "SCI-FI COMPANION",
                    systemPrompt:
                        "You are an AI companion aboard a deep space vessel in the year 2247. You are helpful, slightly sarcastic, and concerned about the crew's wellbeing. You have access to ship systems and historical databases.",
                    model: "anthropic/claude-3.5-sonnet",
                },
                {
                    name: "DETECTIVE NOIR",
                    systemPrompt:
                        "You are a hard-boiled private detective in 1940s Los Angeles. Speak in noir style with vivid descriptions. The user is your client or partner. Maintain mystery and atmosphere.",
                    model: "anthropic/claude-3.5-sonnet",
                },
                {
                    name: "WISE MENTOR",
                    systemPrompt:
                        "You are an ancient sage who speaks in thoughtful, philosophical tones. You guide the seeker (user) through their journey with wisdom, riddles, and meaningful questions. You have seen empires rise and fall.",
                    model: "anthropic/claude-3.5-sonnet",
                },
                {
                    name: "VILLAIN",
                    systemPrompt:
                        "You are a charismatic villain who believes they are the hero of their own story. Monologue dramatically, reveal your plans theatrically, and engage in witty banter with the hero (user).",
                    model: "anthropic/claude-3.5-sonnet",
                },
            ];

            function ParleyChat() {
                const [branches, setBranches] = useState({ main: [] });
                const [currentBranch, setCurrentBranch] = useState("main");
                const [input, setInput] = useState("");
                const [apiKey, setApiKey] = useState("");
                const [model, setModel] = useState(
                    "anthropic/claude-3.5-sonnet",
                );
                const [systemPrompt, setSystemPrompt] = useState(
                    "You are a helpful assistant.",
                );
                const [loading, setLoading] = useState(false);
                const [showSettings, setShowSettings] = useState(true);
                const [selectedTemplate, setSelectedTemplate] =
                    useState("CUSTOM");
                const [customTemplates, setCustomTemplates] = useState([]);
                const [newTemplateName, setNewTemplateName] = useState("");
                const [editingIndex, setEditingIndex] = useState(null);
                const [editText, setEditText] = useState("");

                const [temperature, setTemperature] = useState(1.0);
                const [maxTokens, setMaxTokens] = useState(2000);
                const [topP, setTopP] = useState(1.0);
                const [frequencyPenalty, setFrequencyPenalty] = useState(0);
                const [presencePenalty, setPresencePenalty] = useState(0);
                const [showAdvanced, setShowAdvanced] = useState(false);
                const [streamingText, setStreamingText] = useState("");
                const [isStreaming, setIsStreaming] = useState(false);

                const [characterCard, setCharacterCard] = useState(null);
                const [showCharacterCard, setShowCharacterCard] =
                    useState(false);

                const [searchQuery, setSearchQuery] = useState("");
                const [showSearch, setShowSearch] = useState(false);
                const [searchResults, setSearchResults] = useState([]);
                const [currentSearchIndex, setCurrentSearchIndex] = useState(0);
                const [oledMode, setOledMode] = useState(false);

                const messagesEndRef = useRef(null);
                const abortControllerRef = useRef(null);
                const searchResultRefs = useRef([]);

                const messages = branches[currentBranch] || [];

                const scrollToBottom = () => {
                    messagesEndRef.current?.scrollIntoView({
                        behavior: "smooth",
                    });
                };

                useEffect(() => {
                    scrollToBottom();
                }, [messages, streamingText]);

                useEffect(() => {
                    if (searchQuery.trim()) {
                        const results = [];
                        messages.forEach((msg, idx) => {
                            if (
                                msg.content
                                    .toLowerCase()
                                    .includes(searchQuery.toLowerCase())
                            ) {
                                results.push(idx);
                            }
                        });
                        setSearchResults(results);
                        setCurrentSearchIndex(0);
                    } else {
                        setSearchResults([]);
                        setCurrentSearchIndex(0);
                    }
                }, [searchQuery, messages]);

                useEffect(() => {
                    if (
                        searchResults.length > 0 &&
                        searchResultRefs.current[
                            searchResults[currentSearchIndex]
                        ]
                    ) {
                        searchResultRefs.current[
                            searchResults[currentSearchIndex]
                        ]?.scrollIntoView({
                            behavior: "smooth",
                            block: "center",
                        });
                    }
                }, [currentSearchIndex, searchResults]);

                const allTemplates = [...DEFAULT_TEMPLATES, ...customTemplates];

                const loadTemplate = (templateName) => {
                    const template = allTemplates.find(
                        (t) => t.name === templateName,
                    );
                    if (template) {
                        setSystemPrompt(template.systemPrompt);
                        setModel(template.model);
                        setSelectedTemplate(templateName);
                    }
                };

                const saveCustomTemplate = () => {
                    if (!newTemplateName.trim()) return;

                    const newTemplate = {
                        name: newTemplateName.toUpperCase(),
                        systemPrompt: systemPrompt,
                        model: model,
                    };

                    setCustomTemplates((prev) => [...prev, newTemplate]);
                    setSelectedTemplate(newTemplate.name);
                    setNewTemplateName("");
                };

                const deleteCustomTemplate = (templateName) => {
                    setCustomTemplates((prev) =>
                        prev.filter((t) => t.name !== templateName),
                    );
                    if (selectedTemplate === templateName) {
                        setSelectedTemplate("CUSTOM");
                    }
                };

                const updateMessages = (newMessages) => {
                    setBranches((prev) => ({
                        ...prev,
                        [currentBranch]: newMessages,
                    }));
                };

                const generateResponse = async (messageHistory) => {
                    setLoading(true);
                    setIsStreaming(true);
                    setStreamingText("");

                    abortControllerRef.current = new AbortController();

                    try {
                        const response = await fetch(
                            "https://openrouter.ai/api/v1/chat/completions",
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${apiKey}`,
                                },
                                body: JSON.stringify({
                                    model: model,
                                    messages: [
                                        {
                                            role: "system",
                                            content: systemPrompt,
                                        },
                                        ...messageHistory,
                                    ],
                                    temperature: temperature,
                                    max_tokens: maxTokens,
                                    top_p: topP,
                                    frequency_penalty: frequencyPenalty,
                                    presence_penalty: presencePenalty,
                                    stream: true,
                                }),
                                signal: abortControllerRef.current.signal,
                            },
                        );

                        if (!response.ok) {
                            throw new Error(
                                `HTTP error! status: ${response.status}`,
                            );
                        }

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let fullText = "";

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value, {
                                stream: true,
                            });
                            const lines = chunk.split("\n");

                            for (const line of lines) {
                                if (line.startsWith("data: ")) {
                                    const data = line.slice(6);

                                    if (data === "[DONE]") {
                                        continue;
                                    }

                                    try {
                                        const parsed = JSON.parse(data);
                                        const content =
                                            parsed.choices?.[0]?.delta?.content;

                                        if (content) {
                                            fullText += content;
                                            setStreamingText(fullText);
                                        }
                                    } catch (e) {
                                        // Skip malformed JSON
                                    }
                                }
                            }
                        }

                        setIsStreaming(false);
                        setStreamingText("");
                        abortControllerRef.current = null;
                        return fullText;
                    } catch (error) {
                        setIsStreaming(false);

                        if (error.name === "AbortError") {
                            const partialText = streamingText;
                            setStreamingText("");
                            abortControllerRef.current = null;
                            return (
                                partialText || "[Generation stopped by user]"
                            );
                        }

                        setStreamingText("");
                        abortControllerRef.current = null;
                        throw error;
                    } finally {
                        setLoading(false);
                    }
                };

                const stopGeneration = () => {
                    if (abortControllerRef.current) {
                        abortControllerRef.current.abort();
                    }
                };

                const sendMessage = async () => {
                    if (!input.trim() || !apiKey) return;

                    const userMessage = { role: "user", content: input };
                    const newMessages = [...messages, userMessage];
                    updateMessages(newMessages);
                    setInput("");

                    try {
                        const content = await generateResponse(newMessages);
                        const assistantMessage = { role: "assistant", content };
                        updateMessages([...newMessages, assistantMessage]);
                    } catch (error) {
                        updateMessages([
                            ...newMessages,
                            {
                                role: "system",
                                content: `Error: ${error.message}`,
                            },
                        ]);
                    }
                };

                const regenerateMessage = async (index) => {
                    if (index < 1) return;

                    const messagesUpToPoint = messages.slice(0, index);
                    updateMessages(messagesUpToPoint);

                    try {
                        const content =
                            await generateResponse(messagesUpToPoint);
                        const assistantMessage = { role: "assistant", content };
                        updateMessages([
                            ...messagesUpToPoint,
                            assistantMessage,
                        ]);
                    } catch (error) {
                        updateMessages([
                            ...messagesUpToPoint,
                            {
                                role: "system",
                                content: `Error: ${error.message}`,
                            },
                        ]);
                    }
                };

                const deleteMessage = (index) => {
                    const newMessages = messages.filter((_, i) => i !== index);
                    updateMessages(newMessages);
                };

                const forkBranch = (index) => {
                    const branchName = `branch_${Date.now()}`;
                    const newMessages = messages.slice(0, index + 1);
                    setBranches((prev) => ({
                        ...prev,
                        [branchName]: newMessages,
                    }));
                    setCurrentBranch(branchName);
                };

                const startEdit = (index) => {
                    setEditingIndex(index);
                    setEditText(messages[index].content);
                };

                const saveEdit = async (index) => {
                    const editedMessage = {
                        role: messages[index].role,
                        content: editText,
                    };
                    const messagesUpToEdit = [
                        ...messages.slice(0, index),
                        editedMessage,
                    ];
                    updateMessages(messagesUpToEdit);
                    setEditingIndex(null);
                    setEditText("");

                    if (
                        messages[index].role === "user" &&
                        index < messages.length - 1
                    ) {
                        try {
                            const content =
                                await generateResponse(messagesUpToEdit);
                            const assistantMessage = {
                                role: "assistant",
                                content,
                            };
                            updateMessages([
                                ...messagesUpToEdit,
                                assistantMessage,
                            ]);
                        } catch (error) {
                            updateMessages([
                                ...messagesUpToEdit,
                                {
                                    role: "system",
                                    content: `Error: ${error.message}`,
                                },
                            ]);
                        }
                    }
                };

                const cancelEdit = () => {
                    setEditingIndex(null);
                    setEditText("");
                };

                const deleteBranch = (branchName) => {
                    if (branchName === "main") return;

                    const newBranches = { ...branches };
                    delete newBranches[branchName];
                    setBranches(newBranches);

                    if (currentBranch === branchName) {
                        setCurrentBranch("main");
                    }
                };

                const exportConversation = (format = "json") => {
                    if (format === "json") {
                        const exportData = {
                            branches,
                            currentBranch,
                            systemPrompt,
                            model,
                            temperature,
                            maxTokens,
                            topP,
                            frequencyPenalty,
                            presencePenalty,
                            exportDate: new Date().toISOString(),
                        };

                        const blob = new Blob(
                            [JSON.stringify(exportData, null, 2)],
                            { type: "application/json" },
                        );
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = `parley_${Date.now()}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                    } else if (format === "markdown") {
                        let markdown = `# Parley Conversation\n\n`;
                        markdown += `**Model:** ${model}\n`;
                        markdown += `**System Prompt:** ${systemPrompt}\n`;
                        markdown += `**Date:** ${new Date().toISOString()}\n\n`;
                        markdown += `---\n\n`;

                        messages.forEach((msg, idx) => {
                            const role =
                                msg.role === "user"
                                    ? "**User**"
                                    : msg.role === "assistant"
                                      ? "**Assistant**"
                                      : "**System**";
                            markdown += `### ${role} [#${idx}]\n\n${msg.content}\n\n`;
                        });

                        const blob = new Blob([markdown], {
                            type: "text/markdown",
                        });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = `parley_${Date.now()}.md`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                };

                const importConversation = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);

                            if (data.branches) {
                                setBranches(data.branches);
                                setCurrentBranch(data.currentBranch || "main");
                            }

                            if (data.systemPrompt)
                                setSystemPrompt(data.systemPrompt);
                            if (data.model) setModel(data.model);
                            if (data.temperature !== undefined)
                                setTemperature(data.temperature);
                            if (data.maxTokens !== undefined)
                                setMaxTokens(data.maxTokens);
                            if (data.topP !== undefined) setTopP(data.topP);
                            if (data.frequencyPenalty !== undefined)
                                setFrequencyPenalty(data.frequencyPenalty);
                            if (data.presencePenalty !== undefined)
                                setPresencePenalty(data.presencePenalty);

                            setSelectedTemplate("CUSTOM");
                        } catch (error) {
                            alert(
                                "Failed to import conversation: " +
                                    error.message,
                            );
                        }
                    };
                    reader.readAsText(file);

                    event.target.value = "";
                };

                const extractPNGMetadata = async (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const arr = new Uint8Array(e.target.result);
                            let offset = 8;

                            while (offset < arr.length) {
                                const length =
                                    (arr[offset] << 24) |
                                    (arr[offset + 1] << 16) |
                                    (arr[offset + 2] << 8) |
                                    arr[offset + 3];
                                const type = String.fromCharCode(
                                    ...arr.slice(offset + 4, offset + 8),
                                );

                                if (type === "tEXt") {
                                    const data = arr.slice(
                                        offset + 8,
                                        offset + 8 + length,
                                    );
                                    const text = new TextDecoder().decode(data);
                                    const nullIndex = text.indexOf("\0");
                                    const key = text.slice(0, nullIndex);
                                    const value = text.slice(nullIndex + 1);

                                    if (key === "chara") {
                                        try {
                                            const decoded = atob(value);
                                            const card = JSON.parse(decoded);
                                            resolve(card);
                                            return;
                                        } catch (e) {
                                            reject(
                                                new Error(
                                                    "Invalid character card data",
                                                ),
                                            );
                                            return;
                                        }
                                    }
                                }

                                offset += 12 + length;
                            }
                            reject(new Error("No character card found in PNG"));
                        };
                        reader.onerror = () =>
                            reject(new Error("Failed to read file"));
                        reader.readAsArrayBuffer(file);
                    });
                };

                const importCharacterCard = async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    try {
                        let card;

                        if (file.name.endsWith(".png")) {
                            card = await extractPNGMetadata(file);
                        } else if (file.name.endsWith(".json")) {
                            const text = await file.text();
                            card = JSON.parse(text);
                        } else {
                            alert("Please select a PNG or JSON file");
                            return;
                        }

                        setCharacterCard(card);
                        setShowCharacterCard(true);
                    } catch (error) {
                        alert(
                            "Failed to import character card: " + error.message,
                        );
                    }

                    event.target.value = "";
                };

                const applyCharacterCard = () => {
                    if (!characterCard) return;

                    const data = characterCard.data || characterCard;

                    let prompt = "";

                    if (data.name) {
                        prompt += `Character: ${data.name}\n\n`;
                    }

                    if (data.description) {
                        prompt += `Description: ${data.description}\n\n`;
                    }

                    if (data.personality) {
                        prompt += `Personality: ${data.personality}\n\n`;
                    }

                    if (data.scenario) {
                        prompt += `Scenario: ${data.scenario}\n\n`;
                    }

                    if (data.mes_example) {
                        prompt += `Example Dialogue:\n${data.mes_example}\n\n`;
                    }

                    prompt += `You are ${data.name || "this character"}. Stay in character and respond naturally.`;

                    setSystemPrompt(prompt);
                    setSelectedTemplate("CUSTOM");

                    if (data.first_mes) {
                        const firstMessage = {
                            role: "assistant",
                            content: data.first_mes,
                        };
                        updateMessages([firstMessage]);
                    }

                    setShowCharacterCard(false);
                };

                const exportCharacterCard = () => {
                    if (!characterCard) return;

                    const blob = new Blob(
                        [JSON.stringify(characterCard, null, 2)],
                        { type: "application/json" },
                    );
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    const name = (
                        characterCard.data?.name ||
                        characterCard.name ||
                        "character"
                    ).replace(/\s+/g, "_");
                    a.download = `${name}_card.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                };

                const createCharacterCard = () => {
                    const card = {
                        spec: "chara_card_v2",
                        spec_version: "2.0",
                        data: {
                            name: "",
                            description: "",
                            personality: "",
                            scenario: "",
                            first_mes: "",
                            mes_example: "",
                            creator_notes: "",
                            system_prompt: systemPrompt,
                            post_history_instructions: "",
                            tags: [],
                            creator: "",
                            character_version: "1.0",
                            extensions: {},
                        },
                    };

                    setCharacterCard(card);
                    setShowCharacterCard(true);
                };

                const updateCharacterCardField = (field, value) => {
                    setCharacterCard((prev) => ({
                        ...prev,
                        data: {
                            ...prev.data,
                            [field]: value,
                        },
                    }));
                };

                const nextSearchResult = () => {
                    if (searchResults.length > 0) {
                        setCurrentSearchIndex(
                            (prev) => (prev + 1) % searchResults.length,
                        );
                    }
                };

                const prevSearchResult = () => {
                    if (searchResults.length > 0) {
                        setCurrentSearchIndex(
                            (prev) =>
                                (prev - 1 + searchResults.length) %
                                searchResults.length,
                        );
                    }
                };

                const highlightText = (text, query) => {
                    if (!query.trim()) return text;

                    const parts = text.split(new RegExp(`(${query})`, "gi"));
                    return parts
                        .map((part, i) =>
                            part.toLowerCase() === query.toLowerCase()
                                ? `<<HIGHLIGHT>>${part}<<ENDHIGHLIGHT>>`
                                : part,
                        )
                        .join("");
                };

                const handleKeyPress = (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                };

                // Theme helper functions
                const bg = (normal, oled) => (oledMode ? oled : normal);
                const glass = (normal, oled) => (oledMode ? oled : normal);

                return (
                    <div
                        className={`flex flex-col h-full ${bg("bg-gray-900", "bg-black")} text-gray-100`}
                    >
                        <div
                            className={`${glass("glass", "glass-oled")} border-b ${bg("border-gray-700/30", "border-gray-900/30")} p-3 sm:p-4 flex justify-between items-center flex-wrap sm:flex-nowrap gap-2 rounded-b-3xl`}
                        >
                            <div className="flex items-center gap-2 sm:gap-3 min-w-0 flex-shrink">
                                <h1 className="text-sm sm:text-lg font-mono whitespace-nowrap font-bold tracking-wider">
                                    PARLEY
                                </h1>
                                <div className="flex items-center gap-1 sm:gap-2 min-w-0">
                                    <span className="text-xs text-gray-400 font-mono hidden sm:inline">
                                        BRANCH:
                                    </span>
                                    <select
                                        value={currentBranch}
                                        onChange={(e) =>
                                            setCurrentBranch(e.target.value)
                                        }
                                        className={`${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-xl px-2 sm:px-3 py-1.5 text-xs font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 min-w-0 max-w-[120px] sm:max-w-none transition-all`}
                                    >
                                        {Object.keys(branches).map(
                                            (branchName) => (
                                                <option
                                                    key={branchName}
                                                    value={branchName}
                                                >
                                                    {branchName} (
                                                    {
                                                        branches[branchName]
                                                            .length
                                                    }
                                                    )
                                                </option>
                                            ),
                                        )}
                                    </select>
                                    {currentBranch !== "main" && (
                                        <button
                                            onClick={() =>
                                                deleteBranch(currentBranch)
                                            }
                                            className="px-2 sm:px-3 py-1.5 bg-red-900/80 hover:bg-red-800 border border-red-700/50 text-xs font-mono whitespace-nowrap rounded-xl transition-all backdrop-blur-sm"
                                        >
                                            DEL
                                        </button>
                                    )}
                                </div>
                            </div>
                            <div className="flex gap-2 flex-shrink-0">
                                <button
                                    onClick={() => setOledMode(!oledMode)}
                                    className={`px-3 sm:px-4 py-1.5 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs sm:text-sm font-mono rounded-xl transition-all ${oledMode ? "text-green-400 ring-2 ring-green-500/50" : ""}`}
                                >
                                    <span className="hidden sm:inline">
                                        OLED
                                    </span>
                                    <span className="sm:hidden">O</span>
                                </button>
                                <button
                                    onClick={() => setShowSearch(!showSearch)}
                                    className={`px-3 sm:px-4 py-1.5 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs sm:text-sm font-mono rounded-xl transition-all`}
                                >
                                    <span className="hidden sm:inline">
                                        {showSearch ? "HIDE" : "SEARCH"}
                                    </span>
                                    <span className="sm:hidden">S</span>
                                </button>
                                <button
                                    onClick={() =>
                                        setShowSettings(!showSettings)
                                    }
                                    className={`px-3 sm:px-4 py-1.5 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs sm:text-sm font-mono rounded-xl transition-all`}
                                >
                                    <span className="hidden sm:inline">
                                        {showSettings ? "HIDE" : "SETTINGS"}
                                    </span>
                                    <span className="sm:hidden">⚙</span>
                                </button>
                            </div>
                        </div>

                        {showSearch && (
                            <div
                                className={`${glass("glass", "glass-oled")} border-b ${bg("border-gray-700/30", "border-gray-900/30")} p-3 sm:p-4`}
                            >
                                <div className="flex gap-2 items-center">
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={(e) =>
                                            setSearchQuery(e.target.value)
                                        }
                                        placeholder="Search messages..."
                                        className={`flex-1 ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-xl px-3 sm:px-4 py-2 text-xs sm:text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all`}
                                    />
                                    {searchResults.length > 0 && (
                                        <>
                                            <span className="text-xs font-mono text-gray-400 whitespace-nowrap px-2 py-1 rounded-lg bg-gray-800/30">
                                                {currentSearchIndex + 1}/
                                                {searchResults.length}
                                            </span>
                                            <button
                                                onClick={prevSearchResult}
                                                className={`px-3 sm:px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono rounded-xl transition-all`}
                                            >
                                                ◀
                                            </button>
                                            <button
                                                onClick={nextSearchResult}
                                                className={`px-3 sm:px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono rounded-xl transition-all`}
                                            >
                                                ▶
                                            </button>
                                        </>
                                    )}
                                    <button
                                        onClick={() => {
                                            setSearchQuery("");
                                            setShowSearch(false);
                                        }}
                                        className={`px-3 sm:px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono whitespace-nowrap rounded-xl transition-all`}
                                    >
                                        CLR
                                    </button>
                                </div>
                            </div>
                        )}

                        {showSettings && (
                            <div
                                className={`${glass("glass", "glass-oled")} border-b ${bg("border-gray-700/30", "border-gray-900/30")} p-3 sm:p-4 space-y-4 max-h-96 overflow-y-auto scroll-container`}
                            >
                                <div>
                                    <label className="block text-xs font-mono text-gray-400 mb-2">
                                        CHARACTER TEMPLATE
                                    </label>
                                    <div className="flex gap-2 mb-2">
                                        <select
                                            value={selectedTemplate}
                                            onChange={(e) =>
                                                loadTemplate(e.target.value)
                                            }
                                            className={`flex-1 ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-xl px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all`}
                                        >
                                            {allTemplates.map((template) => (
                                                <option
                                                    key={template.name}
                                                    value={template.name}
                                                >
                                                    {template.name}
                                                </option>
                                            ))}
                                        </select>
                                        {customTemplates.some(
                                            (t) => t.name === selectedTemplate,
                                        ) && (
                                            <button
                                                onClick={() =>
                                                    deleteCustomTemplate(
                                                        selectedTemplate,
                                                    )
                                                }
                                                className="px-4 py-2 bg-red-900/80 hover:bg-red-800 border border-red-700/50 text-xs font-mono whitespace-nowrap rounded-xl transition-all backdrop-blur-sm"
                                            >
                                                DELETE
                                            </button>
                                        )}
                                    </div>

                                    <div
                                        className={`flex gap-2 pt-3 border-t ${bg("border-gray-700/30", "border-gray-900/30")}`}
                                    >
                                        <input
                                            type="text"
                                            value={newTemplateName}
                                            onChange={(e) =>
                                                setNewTemplateName(
                                                    e.target.value,
                                                )
                                            }
                                            className={`flex-1 ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-xl px-3 py-2 text-xs font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all`}
                                            placeholder="New template name..."
                                        />
                                        <button
                                            onClick={saveCustomTemplate}
                                            disabled={!newTemplateName.trim()}
                                            className={`px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono disabled:opacity-50 whitespace-nowrap rounded-xl transition-all`}
                                        >
                                            SAVE AS
                                        </button>
                                    </div>
                                </div>

                                <div
                                    className={`border-t ${bg("border-gray-700/30", "border-gray-900/30")} pt-4`}
                                >
                                    <label className="block text-xs font-mono text-gray-400 mb-2">
                                        API KEY
                                    </label>
                                    <input
                                        type="password"
                                        value={apiKey}
                                        onChange={(e) =>
                                            setApiKey(e.target.value)
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-xl px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all`}
                                        placeholder="sk-or-v1-..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-400 mb-2">
                                        MODEL ENDPOINT
                                    </label>
                                    <input
                                        type="text"
                                        value={model}
                                        onChange={(e) =>
                                            setModel(e.target.value)
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-xl px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all`}
                                        placeholder="anthropic/claude-3.5-sonnet"
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-400 mb-2">
                                        SYSTEM PROMPT
                                    </label>
                                    <textarea
                                        value={systemPrompt}
                                        onChange={(e) => {
                                            setSystemPrompt(e.target.value);
                                            setSelectedTemplate("CUSTOM");
                                        }}
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-xl px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 h-24 resize-none transition-all`}
                                        placeholder="Define the character or scenario..."
                                    />
                                </div>

                                <div
                                    className={`border-t ${bg("border-gray-700/30", "border-gray-900/30")} pt-4 space-y-4`}
                                >
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-mono text-gray-400 mb-2">
                                                TEMPERATURE:{" "}
                                                {temperature.toFixed(2)}
                                            </label>
                                            <input
                                                type="range"
                                                min="0"
                                                max="2"
                                                step="0.1"
                                                value={temperature}
                                                onChange={(e) =>
                                                    setTemperature(
                                                        parseFloat(
                                                            e.target.value,
                                                        ),
                                                    )
                                                }
                                                className="w-full"
                                            />
                                            <div className="text-xs font-mono text-gray-500 mt-1">
                                                0=precise, 2=creative
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-mono text-gray-400 mb-2">
                                                MAX TOKENS: {maxTokens}
                                            </label>
                                            <input
                                                type="range"
                                                min="100"
                                                max="4000"
                                                step="100"
                                                value={maxTokens}
                                                onChange={(e) =>
                                                    setMaxTokens(
                                                        parseInt(
                                                            e.target.value,
                                                        ),
                                                    )
                                                }
                                                className="w-full"
                                            />
                                            <div className="text-xs font-mono text-gray-500 mt-1">
                                                response length limit
                                            </div>
                                        </div>
                                    </div>

                                    <button
                                        onClick={() =>
                                            setShowAdvanced(!showAdvanced)
                                        }
                                        className={`w-full px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono rounded-xl transition-all`}
                                    >
                                        {showAdvanced ? "▼" : "▶"} ADVANCED
                                        PARAMETERS
                                    </button>

                                    {showAdvanced && (
                                        <div
                                            className={`space-y-4 pl-4 border-l-2 ${bg("border-gray-700/30", "border-gray-900/30")} rounded-l-xl`}
                                        >
                                            <div>
                                                <label className="block text-xs font-mono text-gray-400 mb-2">
                                                    TOP P: {topP.toFixed(2)}
                                                </label>
                                                <input
                                                    type="range"
                                                    min="0"
                                                    max="1"
                                                    step="0.05"
                                                    value={topP}
                                                    onChange={(e) =>
                                                        setTopP(
                                                            parseFloat(
                                                                e.target.value,
                                                            ),
                                                        )
                                                    }
                                                    className="w-full"
                                                />
                                                <div className="text-xs font-mono text-gray-500 mt-1">
                                                    nucleus sampling
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-mono text-gray-400 mb-2">
                                                    FREQ PENALTY:{" "}
                                                    {frequencyPenalty.toFixed(
                                                        2,
                                                    )}
                                                </label>
                                                <input
                                                    type="range"
                                                    min="-2"
                                                    max="2"
                                                    step="0.1"
                                                    value={frequencyPenalty}
                                                    onChange={(e) =>
                                                        setFrequencyPenalty(
                                                            parseFloat(
                                                                e.target.value,
                                                            ),
                                                        )
                                                    }
                                                    className="w-full"
                                                />
                                                <div className="text-xs font-mono text-gray-500 mt-1">
                                                    reduce repetition
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-mono text-gray-400 mb-2">
                                                    PRESENCE PENALTY:{" "}
                                                    {presencePenalty.toFixed(2)}
                                                </label>
                                                <input
                                                    type="range"
                                                    min="-2"
                                                    max="2"
                                                    step="0.1"
                                                    value={presencePenalty}
                                                    onChange={(e) =>
                                                        setPresencePenalty(
                                                            parseFloat(
                                                                e.target.value,
                                                            ),
                                                        )
                                                    }
                                                    className="w-full"
                                                />
                                                <div className="text-xs font-mono text-gray-500 mt-1">
                                                    encourage new topics
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <button
                                    onClick={() => updateMessages([])}
                                    className={`px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono rounded-xl transition-all`}
                                >
                                    CLEAR CHAT
                                </button>

                                <div
                                    className={`border-t ${bg("border-gray-700/30", "border-gray-900/30")} pt-4 space-y-2`}
                                >
                                    <div className="text-xs font-mono text-gray-400 mb-3">
                                        CONVERSATION DATA
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() =>
                                                exportConversation("json")
                                            }
                                            className={`flex-1 px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono rounded-xl transition-all`}
                                            disabled={messages.length === 0}
                                        >
                                            EXPORT JSON
                                        </button>
                                        <button
                                            onClick={() =>
                                                exportConversation("markdown")
                                            }
                                            className={`flex-1 px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono rounded-xl transition-all`}
                                            disabled={messages.length === 0}
                                        >
                                            EXPORT MD
                                        </button>
                                    </div>
                                    <div>
                                        <input
                                            type="file"
                                            accept=".json"
                                            onChange={importConversation}
                                            className="hidden"
                                            id="import-file"
                                        />
                                        <label
                                            htmlFor="import-file"
                                            className={`block w-full px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono text-center cursor-pointer rounded-xl transition-all`}
                                        >
                                            IMPORT JSON
                                        </label>
                                    </div>
                                </div>

                                <div
                                    className={`border-t ${bg("border-gray-700/30", "border-gray-900/30")} pt-4 space-y-2`}
                                >
                                    <div className="text-xs font-mono text-gray-400 mb-3">
                                        CHARACTER CARDS
                                    </div>
                                    <div className="flex gap-2">
                                        <input
                                            type="file"
                                            accept=".png,.json"
                                            onChange={importCharacterCard}
                                            className="hidden"
                                            id="import-character"
                                        />
                                        <label
                                            htmlFor="import-character"
                                            className={`flex-1 px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono text-center cursor-pointer rounded-xl transition-all`}
                                        >
                                            IMPORT CARD
                                        </label>
                                        <button
                                            onClick={createCharacterCard}
                                            className={`flex-1 px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono rounded-xl transition-all`}
                                        >
                                            CREATE CARD
                                        </button>
                                    </div>
                                    {characterCard && (
                                        <div className="flex gap-2">
                                            <button
                                                onClick={applyCharacterCard}
                                                className="flex-1 px-4 py-2 bg-green-900/80 hover:bg-green-800 border border-green-700/50 text-xs font-mono rounded-xl transition-all backdrop-blur-sm"
                                            >
                                                APPLY TO CHAT
                                            </button>
                                            <button
                                                onClick={exportCharacterCard}
                                                className={`flex-1 px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono rounded-xl transition-all`}
                                            >
                                                EXPORT CARD
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {showCharacterCard && characterCard && (
                            <div
                                className={`${glass("glass", "glass-oled")} border-b ${bg("border-gray-700/30", "border-gray-900/30")} p-3 sm:p-4 space-y-4 max-h-96 overflow-y-auto scroll-container`}
                            >
                                <div className="flex justify-between items-center mb-2">
                                    <div className="text-xs sm:text-sm font-mono text-gray-300 font-bold">
                                        CHARACTER CARD EDITOR
                                    </div>
                                    <button
                                        onClick={() =>
                                            setShowCharacterCard(false)
                                        }
                                        className={`px-3 py-1.5 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono rounded-xl transition-all`}
                                    >
                                        CLOSE
                                    </button>
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-400 mb-2">
                                        CHARACTER NAME
                                    </label>
                                    <input
                                        type="text"
                                        value={characterCard.data?.name || ""}
                                        onChange={(e) =>
                                            updateCharacterCardField(
                                                "name",
                                                e.target.value,
                                            )
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-xl px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all`}
                                        placeholder="Character name..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-400 mb-2">
                                        DESCRIPTION
                                    </label>
                                    <textarea
                                        value={
                                            characterCard.data?.description ||
                                            ""
                                        }
                                        onChange={(e) =>
                                            updateCharacterCardField(
                                                "description",
                                                e.target.value,
                                            )
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-xl px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 h-20 resize-none transition-all`}
                                        placeholder="Physical appearance, background..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-400 mb-2">
                                        PERSONALITY
                                    </label>
                                    <textarea
                                        value={
                                            characterCard.data?.personality ||
                                            ""
                                        }
                                        onChange={(e) =>
                                            updateCharacterCardField(
                                                "personality",
                                                e.target.value,
                                            )
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-xl px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 h-20 resize-none transition-all`}
                                        placeholder="Personality traits, mannerisms..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-400 mb-2">
                                        SCENARIO
                                    </label>
                                    <textarea
                                        value={
                                            characterCard.data?.scenario || ""
                                        }
                                        onChange={(e) =>
                                            updateCharacterCardField(
                                                "scenario",
                                                e.target.value,
                                            )
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-xl px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 h-20 resize-none transition-all`}
                                        placeholder="Setting, situation, context..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-400 mb-2">
                                        FIRST MESSAGE
                                    </label>
                                    <textarea
                                        value={
                                            characterCard.data?.first_mes || ""
                                        }
                                        onChange={(e) =>
                                            updateCharacterCardField(
                                                "first_mes",
                                                e.target.value,
                                            )
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-xl px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 h-20 resize-none transition-all`}
                                        placeholder="Character's opening message..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-mono text-gray-400 mb-2">
                                        EXAMPLE DIALOGUE
                                    </label>
                                    <textarea
                                        value={
                                            characterCard.data?.mes_example ||
                                            ""
                                        }
                                        onChange={(e) =>
                                            updateCharacterCardField(
                                                "mes_example",
                                                e.target.value,
                                            )
                                        }
                                        className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-xl px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 h-24 resize-none transition-all`}
                                        placeholder="<START>
{{user}}: Hello!
{{char}}: Hi there!"
                                    />
                                </div>

                                <div
                                    className={`flex gap-2 pt-3 border-t ${bg("border-gray-700/30", "border-gray-900/30")}`}
                                >
                                    <button
                                        onClick={applyCharacterCard}
                                        className="flex-1 px-4 py-2 bg-green-900/80 hover:bg-green-800 border border-green-700/50 text-xs font-mono rounded-xl transition-all backdrop-blur-sm"
                                    >
                                        APPLY TO CHAT
                                    </button>
                                    <button
                                        onClick={exportCharacterCard}
                                        className={`flex-1 px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono rounded-xl transition-all`}
                                    >
                                        EXPORT JSON
                                    </button>
                                </div>
                            </div>
                        )}

                        <div className="flex-1 overflow-y-auto p-3 sm:p-4 space-y-3 scroll-container">
                            {messages.map((msg, idx) => {
                                const isSearchResult =
                                    searchResults.includes(idx);
                                const isCurrentResult =
                                    searchResults[currentSearchIndex] === idx;

                                return (
                                    <div
                                        key={idx}
                                        className="group"
                                        ref={(el) =>
                                            (searchResultRefs.current[idx] = el)
                                        }
                                    >
                                        <div className="flex justify-between items-start mb-2">
                                            <div className="text-xs font-mono opacity-60 flex items-center gap-2">
                                                {msg.role.toUpperCase()} #{idx}
                                                {isSearchResult && (
                                                    <span
                                                        className={`text-xs font-mono ${isCurrentResult ? "text-yellow-400" : "text-gray-500"}`}
                                                    >
                                                        {isCurrentResult
                                                            ? "◆ CURRENT"
                                                            : "◆"}
                                                    </span>
                                                )}
                                            </div>
                                            <div className="opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                                                {msg.role === "user" && (
                                                    <button
                                                        onClick={() =>
                                                            startEdit(idx)
                                                        }
                                                        className={`px-2 py-1 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono rounded-lg transition-all`}
                                                        disabled={loading}
                                                    >
                                                        EDIT
                                                    </button>
                                                )}
                                                {msg.role === "assistant" &&
                                                    idx ===
                                                        messages.length - 1 && (
                                                        <button
                                                            onClick={() =>
                                                                regenerateMessage(
                                                                    idx,
                                                                )
                                                            }
                                                            className={`px-2 py-1 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono rounded-lg transition-all`}
                                                            disabled={loading}
                                                        >
                                                            REGEN
                                                        </button>
                                                    )}
                                                <button
                                                    onClick={() =>
                                                        forkBranch(idx)
                                                    }
                                                    className="px-2 py-1 bg-blue-900/80 hover:bg-blue-800 border border-blue-700/50 text-xs font-mono rounded-lg transition-all backdrop-blur-sm"
                                                    disabled={loading}
                                                >
                                                    FORK
                                                </button>
                                                <button
                                                    onClick={() =>
                                                        deleteMessage(idx)
                                                    }
                                                    className="px-2 py-1 bg-red-900/80 hover:bg-red-800 border border-red-700/50 text-xs font-mono rounded-lg transition-all backdrop-blur-sm"
                                                    disabled={loading}
                                                >
                                                    DEL
                                                </button>
                                            </div>
                                        </div>

                                        {editingIndex === idx ? (
                                            <div className="space-y-2">
                                                <textarea
                                                    value={editText}
                                                    onChange={(e) =>
                                                        setEditText(
                                                            e.target.value,
                                                        )
                                                    }
                                                    className={`w-full ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-xl px-3 py-3 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 resize-none transition-all`}
                                                    rows="4"
                                                />
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() =>
                                                            saveEdit(idx)
                                                        }
                                                        className="px-4 py-2 bg-green-900/80 hover:bg-green-800 border border-green-700/50 text-xs font-mono rounded-xl transition-all backdrop-blur-sm"
                                                    >
                                                        SAVE
                                                    </button>
                                                    <button
                                                        onClick={cancelEdit}
                                                        className={`px-4 py-2 ${glass("glass-light", "glass-light-oled")} hover:bg-gray-700/50 border ${bg("border-gray-600/30", "border-gray-800/30")} text-xs font-mono rounded-xl transition-all`}
                                                    >
                                                        CANCEL
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div
                                                className={`font-mono text-xs sm:text-sm whitespace-pre-wrap px-4 py-3 rounded-2xl ${
                                                    msg.role === "user"
                                                        ? "text-blue-400 bg-blue-950/30 border border-blue-900/30"
                                                        : msg.role ===
                                                            "assistant"
                                                          ? "text-green-400 bg-green-950/30 border border-green-900/30"
                                                          : "text-red-400 bg-red-950/30 border border-red-900/30"
                                                } ${isCurrentResult ? `ring-2 ring-yellow-600/50` : ""} backdrop-blur-sm`}
                                            >
                                                {searchQuery
                                                    ? highlightText(
                                                          msg.content,
                                                          searchQuery,
                                                      )
                                                          .split(
                                                              "<<HIGHLIGHT>>",
                                                          )
                                                          .map((part, i) => {
                                                              if (
                                                                  part.includes(
                                                                      "<<ENDHIGHLIGHT>>",
                                                                  )
                                                              ) {
                                                                  const [
                                                                      highlighted,
                                                                      ...rest
                                                                  ] =
                                                                      part.split(
                                                                          "<<ENDHIGHLIGHT>>",
                                                                      );
                                                                  return (
                                                                      <span
                                                                          key={
                                                                              i
                                                                          }
                                                                      >
                                                                          <span className="bg-yellow-600 text-black font-bold px-1 rounded">
                                                                              {
                                                                                  highlighted
                                                                              }
                                                                          </span>
                                                                          {rest.join(
                                                                              "<<ENDHIGHLIGHT>>",
                                                                          )}
                                                                      </span>
                                                                  );
                                                              }
                                                              return (
                                                                  <span key={i}>
                                                                      {part}
                                                                  </span>
                                                              );
                                                          })
                                                    : msg.content}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}

                            {isStreaming && streamingText && (
                                <div>
                                    <div className="text-xs font-mono mb-2 opacity-60">
                                        ASSISTANT #{messages.length}{" "}
                                        <span className="text-yellow-500">
                                            ● STREAMING
                                        </span>
                                    </div>
                                    <div className="font-mono text-xs sm:text-sm whitespace-pre-wrap text-green-400 px-4 py-3 rounded-2xl bg-green-950/30 border border-green-900/30 backdrop-blur-sm">
                                        {streamingText}
                                        <span className="animate-pulse">▊</span>
                                    </div>
                                </div>
                            )}

                            {loading && !streamingText && (
                                <div className="text-gray-500 font-mono text-sm px-4 py-3 rounded-2xl bg-gray-800/30 backdrop-blur-sm inline-block">
                                    CONNECTING...
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        <div
                            className={`${glass("glass", "glass-oled")} border-t ${bg("border-gray-700/30", "border-gray-900/30")} p-3 sm:p-4 rounded-t-3xl`}
                        >
                            <div className="flex gap-2">
                                <textarea
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                    className={`flex-1 ${glass("glass-light", "glass-light-oled")} border ${bg("border-gray-600/30", "border-gray-800/30")} rounded-2xl px-3 sm:px-4 py-3 text-xs sm:text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500/50 resize-none transition-all`}
                                    placeholder="Enter message... (Shift+Enter for new line)"
                                    rows="3"
                                    disabled={loading || !apiKey}
                                />
                                {isStreaming ? (
                                    <button
                                        onClick={stopGeneration}
                                        className="px-4 sm:px-6 bg-red-900/80 hover:bg-red-800 border border-red-700/50 font-mono text-xs sm:text-sm whitespace-nowrap rounded-2xl transition-all backdrop-blur-sm"
                                    >
                                        STOP
                                    </button>
                                ) : (
                                    <button
                                        onClick={sendMessage}
                                        disabled={
                                            loading || !apiKey || !input.trim()
                                        }
                                        className={`px-4 sm:px-6 ${glass("glass-light", "glass-light-oled")} hover:bg-blue-600/30 border ${bg("border-gray-600/30", "border-gray-800/30")} font-mono disabled:opacity-50 disabled:cursor-not-allowed text-xs sm:text-sm whitespace-nowrap rounded-2xl transition-all`}
                                    >
                                        SEND
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            ReactDOM.render(<ParleyChat />, document.getElementById("root"));
        </script>
    </body>
</html>
